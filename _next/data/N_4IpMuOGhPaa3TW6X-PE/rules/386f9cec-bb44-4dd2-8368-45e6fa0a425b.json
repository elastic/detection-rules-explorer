{"pageProps":{"rule":{"hunt":{"author":"Elastic","description":"This hunt looks for either processes connecting to multiple sensitive TCP ports (SMB, RDP, LDAP, Kerberos and ADWS), a high number of SMB/RDP connections to unique destinations or the same process connecting to both RDP and SMB (should be rare).\n","integration":["endpoint","windows"],"uuid":"386f9cec-bb44-4dd2-8368-45e6fa0a425b","name":"Network Discovery via Sensitive Ports by Unusual Process","language":["ES|QL"],"license":"Elastic License v2","notes":["The query thresholds for SMB or RDP need to be adjusted to your environment.","You can add more sensitive ports to the list like FTP, SSH and others.","Elastic Network events include process code signature information, this can be added to filter out signed third party false positives."],"mitre":["T1021","T1021.002","T1021.001"],"query":["from logs-endpoint.events.network-*, logs-windows.sysmon_operational-*\n| where @timestamp > now() - 7 day\n| where host.os.family == \"windows\" and event.category == \"network\" and network.direction == \"egress\" and\n  network.transport == \"tcp\"and destination.port in (3389, 445, 389, 9389, 88, 5985, 5986, 22) and source.port >= 49152 and\n  process.pid != 4\n| keep process.executable, destination.port, destination.ip, process.entity_id\n /* network events with SMB or RDP as a target */\n| eval smb_dip = case(destination.port == 445, destination.ip, null), rdp_dip = case(destination.port == 389, destination.ip, null)\n /* unique count by destination.port, number of distinct SMB and RDP destinations */\n| stats count_unique_ports = count_distinct(destination.port), count_smb_dst =  count_distinct(smb_dip), count_rdp_dst =  count_distinct(rdp_dip) by process.entity_id, process.executable\n| where count_unique_ports >= 3 or count_rdp_dst >= 10 or count_smb_dst >= 10 or (count_rdp_dst >= 1 and count_rdp_dst >= 1)\n"]},"rule":{"tags":["Hunt Type: Hunt"],"query":["from logs-endpoint.events.network-*, logs-windows.sysmon_operational-*\n| where @timestamp > now() - 7 day\n| where host.os.family == \"windows\" and event.category == \"network\" and network.direction == \"egress\" and\n  network.transport == \"tcp\"and destination.port in (3389, 445, 389, 9389, 88, 5985, 5986, 22) and source.port >= 49152 and\n  process.pid != 4\n| keep process.executable, destination.port, destination.ip, process.entity_id\n /* network events with SMB or RDP as a target */\n| eval smb_dip = case(destination.port == 445, destination.ip, null), rdp_dip = case(destination.port == 389, destination.ip, null)\n /* unique count by destination.port, number of distinct SMB and RDP destinations */\n| stats count_unique_ports = count_distinct(destination.port), count_smb_dst =  count_distinct(smb_dip), count_rdp_dst =  count_distinct(rdp_dip) by process.entity_id, process.executable\n| where count_unique_ports >= 3 or count_rdp_dst >= 10 or count_smb_dst >= 10 or (count_rdp_dst >= 1 and count_rdp_dst >= 1)\n"],"license":"Elastic License v2","description":"This hunt looks for either processes connecting to multiple sensitive TCP ports (SMB, RDP, LDAP, Kerberos and ADWS), a high number of SMB/RDP connections to unique destinations or the same process connecting to both RDP and SMB (should be rare).\n","threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"","name":"","reference":""},"technique":[{"id":"T1021","name":"","reference":"https://attack.mitre.org/techniques/T1021/"},{"id":"T1021","name":"","reference":"https://attack.mitre.org/techniques/T1021/","subtechnique":[{"id":"T1021.002","reference":"https://attack.mitre.org/techniques/T1021/002/"}]},{"id":"T1021","name":"","reference":"https://attack.mitre.org/techniques/T1021/","subtechnique":[{"id":"T1021.001","reference":"https://attack.mitre.org/techniques/T1021/001/"}]}]}]},"metadata":{"creation_date":"1970-01-01T00:00:00.000Z","updated_date":"1970-01-01T00:00:00.000Z","integration":["endpoint","windows"]}}},"__N_SSG":true}