{"pageProps":{"rule":{"hunt":{"author":"Elastic","description":"This hunting query identifies when a user makes EC2 `RunInstances` API calls with a high instance deployment count within a 7-day window. The `RunInstances` API call launches one or more instances in a specified subnet. High instance deployment counts may indicate an adversary attempting to deploy a large number of instances for cryptomining or other malicious activities. This may also aid in identifying potential resource abuse or misconfigurations.\n","integration":["aws.cloudtrail"],"uuid":"c3d24ae8-655d-11ef-a990-f661ea17fbcc","name":"High EC2 Instance Deployment Count Attempts by Single User or Role","language":["ES|QL"],"license":"Elastic License v2","notes":["Use the `aws.cloudtrail.user_identity.arn` field to identify the user making the requests and their role permissions","Review `cloud.region` to identify the regions where the `RunInstances` API calls were made","`subnet_id` should be reviewed to identify the subnet where the instances are being deployed but can also help pivot and narrow down the scope of further queries","`instance_type` should be reviewed to identify the type of instances being deployed. Cryptomining campaigns often deploy specific instance types to maximize mining efficiency"],"mitre":["T1578.002"],"query":["from logs-aws.cloudtrail-*\n| where @timestamp > now() - 7 day\n| where\n    event.dataset == \"aws.cloudtrail\"\n    and event.provider == \"ec2.amazonaws.com\"\n    and event.action == \"RunInstances\"\n    and aws.cloudtrail.request_parameters RLIKE \".*minCount.*maxCount.*\"\n| eval date = DATE_FORMAT(\"YYYY-mm-dd\", @timestamp)\n| dissect aws.cloudtrail.request_parameters \"%{}subnetId=%{subnet_id},\"\n| dissect aws.cloudtrail.request_parameters \"%{}minCount=%{min_count},\"\n| dissect aws.cloudtrail.request_parameters \"%{}maxCount=%{max_count}}]},\"\n| dissect aws.cloudtrail.request_parameters \"%{}instanceType=%{instance_type},\"\n| stats\n    target_instance_count = sum(to_integer(max_count) - to_integer(min_count) + 1),\n    user_attempts = count(*) by user.name, date, subnet_id, instance_type, event.outcome\n| where target_instance_count >= 10\n"]},"rule":{"tags":["Hunt Type: Hunt"],"query":["from logs-aws.cloudtrail-*\n| where @timestamp > now() - 7 day\n| where\n    event.dataset == \"aws.cloudtrail\"\n    and event.provider == \"ec2.amazonaws.com\"\n    and event.action == \"RunInstances\"\n    and aws.cloudtrail.request_parameters RLIKE \".*minCount.*maxCount.*\"\n| eval date = DATE_FORMAT(\"YYYY-mm-dd\", @timestamp)\n| dissect aws.cloudtrail.request_parameters \"%{}subnetId=%{subnet_id},\"\n| dissect aws.cloudtrail.request_parameters \"%{}minCount=%{min_count},\"\n| dissect aws.cloudtrail.request_parameters \"%{}maxCount=%{max_count}}]},\"\n| dissect aws.cloudtrail.request_parameters \"%{}instanceType=%{instance_type},\"\n| stats\n    target_instance_count = sum(to_integer(max_count) - to_integer(min_count) + 1),\n    user_attempts = count(*) by user.name, date, subnet_id, instance_type, event.outcome\n| where target_instance_count >= 10\n"],"license":"Elastic License v2","description":"This hunting query identifies when a user makes EC2 `RunInstances` API calls with a high instance deployment count within a 7-day window. The `RunInstances` API call launches one or more instances in a specified subnet. High instance deployment counts may indicate an adversary attempting to deploy a large number of instances for cryptomining or other malicious activities. This may also aid in identifying potential resource abuse or misconfigurations.\n","threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"","name":"","reference":""},"technique":[{"id":"T1578","name":"","reference":"https://attack.mitre.org/techniques/T1578/","subtechnique":[{"id":"T1578.002","reference":"https://attack.mitre.org/techniques/T1578/002/"}]}]}]},"metadata":{"creation_date":"1970-01-01T00:00:00.000Z","updated_date":"1970-01-01T00:00:00.000Z","integration":["aws.cloudtrail"]}}},"__N_SSG":true}