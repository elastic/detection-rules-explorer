{"pageProps":{"rule":{"hunt":{"author":"Elastic","description":"This hunting query identifies when a user makes multiple `DescribeInstances` API calls in multiple regions within a 30-second window. The `DescribeInstances` API call retrieves information about one or more EC2 instances in a region. High frequency of `DescribeInstances` API calls across multiple regions may indicate an adversary attempting to discover the EC2 instances in the account or perform reconnaissance on the EC2 environment.\n","integration":["aws.cloudtrail"],"uuid":"e6e78858-6482-11ef-93bd-f661ea17fbcc","name":"High Frequency of EC2 Multi-Region `DescribeInstances` API Calls","language":["ES|QL"],"license":"Elastic License v2","notes":["Use the `aws.cloudtrail.user_identity.arn` field to identify the user making the requests and their role permissions","Use the `cloud.region` field to identify the regions where the `DescribeInstances` API calls were made","If leveraging SSM, query for `StartSession` API calls to determine if the user is attempting to establish a session with the EC2 instances","Filter for `event.provider` is `ec2.amazonaws.com` to pivot on unusual activity related to EC2 instances"],"mitre":["T1580"],"query":["from logs-aws.cloudtrail-*\n| where @timestamp > now() - 7 day\n\n// filter for DescribeInstances API calls\n| where event.dataset == \"aws.cloudtrail\" and event.provider == \"ec2.amazonaws.com\" and event.action == \"DescribeInstances\"\n\n// truncate the timestamp to a 30-second window\n| eval target_time_window = DATE_TRUNC(30 seconds, @timestamp)\n\n// count the number of unique regions and total API calls within the 30-second window\n| stats region_count = count_distinct(cloud.region), window_count = count(*) by target_time_window, aws.cloudtrail.user_identity.arn\n\n// filter for resources making DescribeInstances API calls in more than 10 regions within the 30-second window\n| where region_count >= 10 and window_count >= 10\n\n// sort the results by time windows in descending order\n| sort target_time_window desc\n"]},"rule":{"tags":["Hunt Type: Hunt"],"query":["from logs-aws.cloudtrail-*\n| where @timestamp > now() - 7 day\n\n// filter for DescribeInstances API calls\n| where event.dataset == \"aws.cloudtrail\" and event.provider == \"ec2.amazonaws.com\" and event.action == \"DescribeInstances\"\n\n// truncate the timestamp to a 30-second window\n| eval target_time_window = DATE_TRUNC(30 seconds, @timestamp)\n\n// count the number of unique regions and total API calls within the 30-second window\n| stats region_count = count_distinct(cloud.region), window_count = count(*) by target_time_window, aws.cloudtrail.user_identity.arn\n\n// filter for resources making DescribeInstances API calls in more than 10 regions within the 30-second window\n| where region_count >= 10 and window_count >= 10\n\n// sort the results by time windows in descending order\n| sort target_time_window desc\n"],"license":"Elastic License v2","description":"This hunting query identifies when a user makes multiple `DescribeInstances` API calls in multiple regions within a 30-second window. The `DescribeInstances` API call retrieves information about one or more EC2 instances in a region. High frequency of `DescribeInstances` API calls across multiple regions may indicate an adversary attempting to discover the EC2 instances in the account or perform reconnaissance on the EC2 environment.\n","threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"","name":"","reference":""},"technique":[{"id":"T1580","name":"","reference":"https://attack.mitre.org/techniques/T1580/"}]}]},"metadata":{"creation_date":"1970-01-01T00:00:00.000Z","updated_date":"1970-01-01T00:00:00.000Z","integration":["aws.cloudtrail"]}}},"__N_SSG":true}