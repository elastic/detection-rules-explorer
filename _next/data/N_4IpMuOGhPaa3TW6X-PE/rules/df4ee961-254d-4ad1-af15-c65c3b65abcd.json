{"pageProps":{"rule":{"hunt":{"author":"Elastic","description":"Leveraging frequency based analysis and random values normalization, this hunt identifies instances where a program adds a persistence entry with rare values or are imited to unique hosts. Run registry key cause programs to run each time that a user logs on and are often abused by adversaries to maintain persistence on an endpoint.\n","integration":["endpoint","windows"],"uuid":"df4ee961-254d-4ad1-af15-c65c3b65abcd","name":"Persistence via Run Key with Low Occurrence Frequency","language":["ES|QL"],"license":"Elastic License v2","notes":["This hunt includes two queries to cover both Sysmon and Elastic Defend data sources.","Sysmon registry events do not populate process code signature information (hence the separation of the queries).","Suspicious paths and LOLBins in the `registry.data.strings` value should be reviewed further."],"mitre":["T1547","T1547.001"],"query":["from logs-endpoint.events.registry-*\n| where  @timestamp > NOW() - 7 day\n| where host.os.family == \"windows\" and event.category == \"registry\" and event.action == \"modification\" and\n  (process.code_signature.exists == false or starts_with(process.code_signature.subject_name, \"Microsoft\")) and\n  ends_with(registry.key,\"\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\") and\n  not registry.data.strings rlike \"\"\"(.{1,2}[c-fC-F]:\\\\Program Files.+)|([c-fC-F]:\\\\Program Files.+)|(.{1,2}[c-fC-F]:\\\\WINDOWS\\\\System32\\\\DriverStore\\\\FileRepository\\\\.+)\"\"\"\n| keep registry.key, registry.data.strings, process.name, host.id\n /* Paths normalization in registry.data.strings to ease aggregation */\n| eval registry_data = replace(registry.data.strings, \"\"\"([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}|ns[a-z][A-Z0-9]{3,4}\\.tmp|DX[A-Z0-9]{3,4}\\.tmp|7z[A-Z0-9]{3,5}\\.tmp|[0-9\\.\\-\\_]{3,})\"\"\", \"\")\n| eval registry_data = replace(registry_data, \"\"\"[cC]:\\\\[uU][sS][eE][rR][sS]\\\\[a-zA-Z0-9単\\.\\-\\_\\$~ ]+\\\\\"\"\", \"C:\\\\\\\\users\\\\\\\\user\\\\\\\\\")\n| stats cc = count(*), hosts = count_distinct(host.id) by process.name, registry_data\n| where hosts == 1 and cc == 1\n","from logs-windows.sysmon_operational-*\n| where  @timestamp > NOW() - 7 day\n| where host.os.family == \"windows\" and event.category == \"registry\" and event.action == \"RegistryEvent (Value Set)\" and\n  ends_with(registry.key,\"\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\") and\n  not registry.data.strings rlike \"\"\"(.{1,2}[c-fC-F]:\\\\Program Files.+)|([c-fC-F]:\\\\Program Files.+)|(.{1,2}[c-fC-F]:\\\\WINDOWS\\\\System32\\\\DriverStore\\\\FileRepository\\\\.+)\"\"\"\n| keep registry.key, registry.data.strings, process.name, host.id\n /* Paths normalization in registry.data.strings to ease aggregation */\n| eval registry_data = replace(registry.data.strings, \"\"\"([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}|ns[a-z][A-Z0-9]{3,4}\\.tmp|DX[A-Z0-9]{3,4}\\.tmp|7z[A-Z0-9]{3,5}\\.tmp|[0-9\\.\\-\\_]{3,})\"\"\", \"\")\n| eval registry_data = replace(registry_data, \"\"\"[cC]:\\\\[uU][sS][eE][rR][sS]\\\\[a-zA-Z0-9単\\.\\-\\_\\$~ ]+\\\\\"\"\", \"C:\\\\\\\\users\\\\\\\\user\\\\\\\\\")\n| stats cc = count(*), hosts = count_distinct(host.id) by process.name, registry_data\n| where hosts == 1 and cc == 1\n"]},"rule":{"tags":["Hunt Type: Hunt"],"query":["from logs-endpoint.events.registry-*\n| where  @timestamp > NOW() - 7 day\n| where host.os.family == \"windows\" and event.category == \"registry\" and event.action == \"modification\" and\n  (process.code_signature.exists == false or starts_with(process.code_signature.subject_name, \"Microsoft\")) and\n  ends_with(registry.key,\"\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\") and\n  not registry.data.strings rlike \"\"\"(.{1,2}[c-fC-F]:\\\\Program Files.+)|([c-fC-F]:\\\\Program Files.+)|(.{1,2}[c-fC-F]:\\\\WINDOWS\\\\System32\\\\DriverStore\\\\FileRepository\\\\.+)\"\"\"\n| keep registry.key, registry.data.strings, process.name, host.id\n /* Paths normalization in registry.data.strings to ease aggregation */\n| eval registry_data = replace(registry.data.strings, \"\"\"([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}|ns[a-z][A-Z0-9]{3,4}\\.tmp|DX[A-Z0-9]{3,4}\\.tmp|7z[A-Z0-9]{3,5}\\.tmp|[0-9\\.\\-\\_]{3,})\"\"\", \"\")\n| eval registry_data = replace(registry_data, \"\"\"[cC]:\\\\[uU][sS][eE][rR][sS]\\\\[a-zA-Z0-9単\\.\\-\\_\\$~ ]+\\\\\"\"\", \"C:\\\\\\\\users\\\\\\\\user\\\\\\\\\")\n| stats cc = count(*), hosts = count_distinct(host.id) by process.name, registry_data\n| where hosts == 1 and cc == 1\n","from logs-windows.sysmon_operational-*\n| where  @timestamp > NOW() - 7 day\n| where host.os.family == \"windows\" and event.category == \"registry\" and event.action == \"RegistryEvent (Value Set)\" and\n  ends_with(registry.key,\"\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\") and\n  not registry.data.strings rlike \"\"\"(.{1,2}[c-fC-F]:\\\\Program Files.+)|([c-fC-F]:\\\\Program Files.+)|(.{1,2}[c-fC-F]:\\\\WINDOWS\\\\System32\\\\DriverStore\\\\FileRepository\\\\.+)\"\"\"\n| keep registry.key, registry.data.strings, process.name, host.id\n /* Paths normalization in registry.data.strings to ease aggregation */\n| eval registry_data = replace(registry.data.strings, \"\"\"([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}|ns[a-z][A-Z0-9]{3,4}\\.tmp|DX[A-Z0-9]{3,4}\\.tmp|7z[A-Z0-9]{3,5}\\.tmp|[0-9\\.\\-\\_]{3,})\"\"\", \"\")\n| eval registry_data = replace(registry_data, \"\"\"[cC]:\\\\[uU][sS][eE][rR][sS]\\\\[a-zA-Z0-9単\\.\\-\\_\\$~ ]+\\\\\"\"\", \"C:\\\\\\\\users\\\\\\\\user\\\\\\\\\")\n| stats cc = count(*), hosts = count_distinct(host.id) by process.name, registry_data\n| where hosts == 1 and cc == 1\n"],"license":"Elastic License v2","description":"Leveraging frequency based analysis and random values normalization, this hunt identifies instances where a program adds a persistence entry with rare values or are imited to unique hosts. Run registry key cause programs to run each time that a user logs on and are often abused by adversaries to maintain persistence on an endpoint.\n","threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"","name":"","reference":""},"technique":[{"id":"T1547","name":"","reference":"https://attack.mitre.org/techniques/T1547/"},{"id":"T1547","name":"","reference":"https://attack.mitre.org/techniques/T1547/","subtechnique":[{"id":"T1547.001","reference":"https://attack.mitre.org/techniques/T1547/001/"}]}]}]},"metadata":{"creation_date":"1970-01-01T00:00:00.000Z","updated_date":"1970-01-01T00:00:00.000Z","integration":["endpoint","windows"]}}},"__N_SSG":true}