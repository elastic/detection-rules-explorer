{"pageProps":{"rule":{"hunt":{"author":"Elastic","description":"This hunt identifies potential persistence mechanisms via cron on Linux systems. It monitors for file creation or modification events related to cron configurations and processes spawned by cron, fcron, or atd. These activities can indicate attempts to establish persistence through scheduled tasks.\n","integration":["endpoint"],"uuid":"e1cffb7c-4acf-4e7a-8d72-b8b7657cf7b8","name":"Persistence via Cron","language":["ES|QL","SQL"],"license":"Elastic License v2","notes":["This hunt includes multiple ES|QL and OSQuery queries to identify potential persistence mechanisms via cron on Linux systems.","Detects file creation or modification events in directories and files associated with cron configurations, such as /etc/cron.allow, /etc/cron.deny, /etc/crontab, all /etc/cron.* directories and various /var/spool directories.","Excludes common legitimate processes and file types to minimize false positives.","Uses EVAL to tag potential persistence events and counts occurrences to identify unusual activity.","Monitors processes started by cron, fcron, or atd to detect potential persistence mechanisms.","OSQuery queries are provided to complement the detection by retrieving detailed file information and crontab entries."],"mitre":["T1053.003","T1053.005"],"query":["from logs-endpoint.events.file-*\n| where @timestamp > now() - 30 day\n| where host.os.type == \"linux\" and event.type in (\"creation\", \"change\") and (\n    file.path in (\"/etc/cron.allow\", \"/etc/cron.deny\", \"/etc/crontab\") or\n    file.path like \"/etc/cron.*/*\" or\n    file.path like \"/var/spool/cron/crontabs/*\" or\n    file.path like \"/var/spool/anacron/*\" or\n    file.path like \"/var/spool/cron/atjobs/*\" or\n    file.path like \"/var/spool/fcron/*\" or\n    file.path like \"/home/*/.tsp/*\"\n) and not (\n    process.name in (\"dpkg\", \"dockerd\", \"yum\", \"dnf\", \"snapd\", \"pacman\", \"pamac-daemon\", \"anacron\") or\n    file.extension in (\"dpkg-remove\", \"swx\", \"swp\") or\n    file.name like \"tmp.*\"\n)\n| eval persistence = case(\n    file.path in (\"/etc/cron.allow\", \"/etc/cron.deny\", \"/etc/crontab\") or\n    file.path like \"/etc/cron.*/*\" or\n    file.path like \"/var/spool/cron/crontabs/*\" or\n    file.path like \"/var/spool/anacron/*\" or\n    file.path like \"/var/spool/cron/atjobs/*\" or\n    file.path like \"/var/spool/fcron/*\" or\n    file.path like \"/home/*/.tsp/*\",\n    process.name,\n    null\n)\n| stats pers_count = count(persistence), agent_count = count_distinct(agent.id) by process.executable, file.path\n| where pers_count > 0 and pers_count <= 20 and agent_count <= 3\n| sort pers_count asc\n| limit 100\n","from logs-endpoint.events.process-*\n| where @timestamp > now() - 30 day\n| where host.os.type == \"linux\" and event.action == \"exec\" and event.type == \"start\" and process.parent.name in (\"cron\", \"fcron\", \"atd\")\n| stats cc = count(), host_count = count_distinct(host.id) by process.command_line\n| where host_count <= 3\n| sort cc asc\n| limit 100\n","SELECT\n    f.filename,\n    f.path,\n    u.username AS file_owner,\n    g.groupname AS group_owner,\n    datetime(f.atime, 'unixepoch') AS file_last_access_time,\n    datetime(f.mtime, 'unixepoch') AS file_last_modified_time,\n    datetime(f.ctime, 'unixepoch') AS file_last_status_change_time,\n    datetime(f.btime, 'unixepoch') AS file_created_time,\n    f.size AS size_bytes\nFROM\n    file f\nLEFT JOIN\n    users u ON f.uid = u.uid\nLEFT JOIN\n    groups g ON f.gid = g.gid\nWHERE\n    f.path IN (\"/etc/cron.allow\", \"/etc/cron.deny\", \"/etc/crontab\")\n    OR f.path LIKE \"/etc/cron.%/*\"\n    OR f.path LIKE \"/var/spool/cron/crontabs/%\"\n    OR f.path LIKE \"/var/spool/anacron/%\"\n    OR f.path LIKE \"/var/spool/cron/atjobs/%\"\n    OR f.path LIKE \"/var/spool/fcron/%\"\n    OR f.path LIKE \"/home/%/.tsp/%\"\n    OR f.path LIKE \"/etc/cron.allow.d/%\"\n    OR f.path LIKE \"/etc/cron.d/%\"\n    OR f.path LIKE \"/etc/cron.hourly/%\"\n    OR f.path LIKE \"/etc/cron.daily/%\"\n    OR f.path LIKE \"/etc/cron.weekly/%\"\n    OR f.path LIKE \"/etc/cron.monthly/%\"\n","SELECT * FROM crontab\n"]},"rule":{"tags":["Hunt Type: Hunt"],"query":["from logs-endpoint.events.file-*\n| where @timestamp > now() - 30 day\n| where host.os.type == \"linux\" and event.type in (\"creation\", \"change\") and (\n    file.path in (\"/etc/cron.allow\", \"/etc/cron.deny\", \"/etc/crontab\") or\n    file.path like \"/etc/cron.*/*\" or\n    file.path like \"/var/spool/cron/crontabs/*\" or\n    file.path like \"/var/spool/anacron/*\" or\n    file.path like \"/var/spool/cron/atjobs/*\" or\n    file.path like \"/var/spool/fcron/*\" or\n    file.path like \"/home/*/.tsp/*\"\n) and not (\n    process.name in (\"dpkg\", \"dockerd\", \"yum\", \"dnf\", \"snapd\", \"pacman\", \"pamac-daemon\", \"anacron\") or\n    file.extension in (\"dpkg-remove\", \"swx\", \"swp\") or\n    file.name like \"tmp.*\"\n)\n| eval persistence = case(\n    file.path in (\"/etc/cron.allow\", \"/etc/cron.deny\", \"/etc/crontab\") or\n    file.path like \"/etc/cron.*/*\" or\n    file.path like \"/var/spool/cron/crontabs/*\" or\n    file.path like \"/var/spool/anacron/*\" or\n    file.path like \"/var/spool/cron/atjobs/*\" or\n    file.path like \"/var/spool/fcron/*\" or\n    file.path like \"/home/*/.tsp/*\",\n    process.name,\n    null\n)\n| stats pers_count = count(persistence), agent_count = count_distinct(agent.id) by process.executable, file.path\n| where pers_count > 0 and pers_count <= 20 and agent_count <= 3\n| sort pers_count asc\n| limit 100\n","from logs-endpoint.events.process-*\n| where @timestamp > now() - 30 day\n| where host.os.type == \"linux\" and event.action == \"exec\" and event.type == \"start\" and process.parent.name in (\"cron\", \"fcron\", \"atd\")\n| stats cc = count(), host_count = count_distinct(host.id) by process.command_line\n| where host_count <= 3\n| sort cc asc\n| limit 100\n","SELECT\n    f.filename,\n    f.path,\n    u.username AS file_owner,\n    g.groupname AS group_owner,\n    datetime(f.atime, 'unixepoch') AS file_last_access_time,\n    datetime(f.mtime, 'unixepoch') AS file_last_modified_time,\n    datetime(f.ctime, 'unixepoch') AS file_last_status_change_time,\n    datetime(f.btime, 'unixepoch') AS file_created_time,\n    f.size AS size_bytes\nFROM\n    file f\nLEFT JOIN\n    users u ON f.uid = u.uid\nLEFT JOIN\n    groups g ON f.gid = g.gid\nWHERE\n    f.path IN (\"/etc/cron.allow\", \"/etc/cron.deny\", \"/etc/crontab\")\n    OR f.path LIKE \"/etc/cron.%/*\"\n    OR f.path LIKE \"/var/spool/cron/crontabs/%\"\n    OR f.path LIKE \"/var/spool/anacron/%\"\n    OR f.path LIKE \"/var/spool/cron/atjobs/%\"\n    OR f.path LIKE \"/var/spool/fcron/%\"\n    OR f.path LIKE \"/home/%/.tsp/%\"\n    OR f.path LIKE \"/etc/cron.allow.d/%\"\n    OR f.path LIKE \"/etc/cron.d/%\"\n    OR f.path LIKE \"/etc/cron.hourly/%\"\n    OR f.path LIKE \"/etc/cron.daily/%\"\n    OR f.path LIKE \"/etc/cron.weekly/%\"\n    OR f.path LIKE \"/etc/cron.monthly/%\"\n","SELECT * FROM crontab\n"],"license":"Elastic License v2","description":"This hunt identifies potential persistence mechanisms via cron on Linux systems. It monitors for file creation or modification events related to cron configurations and processes spawned by cron, fcron, or atd. These activities can indicate attempts to establish persistence through scheduled tasks.\n","threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"","name":"","reference":""},"technique":[{"id":"T1053","name":"","reference":"https://attack.mitre.org/techniques/T1053/","subtechnique":[{"id":"T1053.003","reference":"https://attack.mitre.org/techniques/T1053/003/"}]},{"id":"T1053","name":"","reference":"https://attack.mitre.org/techniques/T1053/","subtechnique":[{"id":"T1053.005","reference":"https://attack.mitre.org/techniques/T1053/005/"}]}]}]},"metadata":{"creation_date":"1970-01-01T00:00:00.000Z","updated_date":"1970-01-01T00:00:00.000Z","integration":["endpoint"]}}},"__N_SSG":true}