{"pageProps":{"rule":{"hunt":{"author":"Elastic","description":"This hunt identifies potential persistence mechanisms via systemd (timers) on Linux systems. It monitors for file creation or modification events related to systemd service and timer configurations, as well as generators, which can indicate attempts to establish persistence through scheduled tasks.\n","integration":["endpoint"],"uuid":"d2d24ad6-a315-4e05-a3f9-e205eb805df4","name":"Persistence via Systemd (Timers)","language":["ES|QL","SQL"],"license":"Elastic License v2","notes":["This hunt includes multiple ES|QL and OSQuery queries to identify potential persistence mechanisms via systemd timers on Linux systems.","Detects file creation or modification events in directories and files associated with systemd services, timers, and generators, such as /run/systemd/system, /etc/systemd/system, /etc/systemd/user, and various /usr/lib/systemd directories.","Excludes common legitimate processes and file types to minimize false positives.","Uses EVAL to tag potential persistence events and counts occurrences to identify unusual activity.","OSQuery queries are provided to complement the detection by retrieving detailed file information and entries related to systemd services, timers, and generators."],"mitre":["T1053.005","T1546.002"],"query":["from logs-endpoint.events.file-*\n| where @timestamp > now() - 30 day\n| where host.os.type == \"linux\" and event.type in (\"creation\", \"change\") and (\n\n    // System-wide/user-specific services/timers (root permissions required)\n    file.path like \"/run/systemd/system/*\" or\n    file.path like \"/etc/systemd/system/*\" or\n    file.path like \"/etc/systemd/user/*\" or\n    file.path like \"/usr/local/lib/systemd/system/*\" or\n    file.path like \"/lib/systemd/system/*\" or\n    file.path like \"/usr/lib/systemd/system/*\" or\n    file.path like \"/usr/lib/systemd/user/*\" or\n\n    // user-specific services/timers (user permissions required)\n    file.path like \"/home/*/.config/systemd/user/*\" or\n    file.path like \"/home/*/.local/share/systemd/user/*\" or\n\n    // System-wide generators (root permissions required)\n    file.path like \"/etc/systemd/system-generators/*\" or\n    file.path like \"/usr/local/lib/systemd/system-generators/*\" or\n    file.path like \"/lib/systemd/system-generators/*\" or\n    file.path like \"/etc/systemd/user-generators/*\" or\n    file.path like \"/usr/local/lib/systemd/user-generators/*\" or\n    file.path like \"/usr/lib/systemd/user-generators/*\"\n\n) and not (\n    process.name in (\n      \"dpkg\", \"dockerd\", \"yum\", \"dnf\", \"snapd\", \"pacman\", \"pamac-daemon\",\n      \"netplan\", \"systemd\", \"generate\"\n    ) or\n    process.executable == \"/proc/self/exe\" or\n    process.executable like \"/dev/fd/*\" or\n    file.extension in (\"dpkg-remove\", \"swx\", \"swp\")\n)\n| eval persistence = case(\n\n    // System-wide/user-specific services/timers (root permissions required)\n    file.path like \"/run/systemd/system/*\" or\n    file.path like \"/etc/systemd/system/*\" or\n    file.path like \"/etc/systemd/user/*\" or\n    file.path like \"/usr/local/lib/systemd/system/*\" or\n    file.path like \"/lib/systemd/system/*\" or\n    file.path like \"/usr/lib/systemd/system/*\" or\n    file.path like \"/usr/lib/systemd/user/*\" or\n\n    // user-specific services/timers (user permissions required)\n    file.path like \"/home/*/.config/systemd/user/*\" or\n    file.path like \"/home/*/.local/share/systemd/user/*\" or\n\n    // System-wide generators (root permissions required)\n    file.path like \"/etc/systemd/system-generators/*\" or\n    file.path like \"/usr/local/lib/systemd/system-generators/*\" or\n    file.path like \"/lib/systemd/system-generators/*\" or\n    file.path like \"/etc/systemd/user-generators/*\" or\n    file.path like \"/usr/local/lib/systemd/user-generators/*\" or\n    file.path like \"/usr/lib/systemd/user-generators/*\",\n    process.name,\n    null\n)\n| stats pers_count = count(persistence) by process.executable, file.path\n| where pers_count > 0 and pers_count <= 20\n| sort pers_count asc\n| limit 100\n","SELECT\n    f.filename,\n    f.path,\n    u.username AS file_owner,\n    g.groupname AS group_owner,\n    datetime(f.atime, 'unixepoch') AS file_last_access_time,\n    datetime(f.mtime, 'unixepoch') AS file_last_modified_time,\n    datetime(f.ctime, 'unixepoch') AS file_last_status_change_time,\n    datetime(f.btime, 'unixepoch') AS file_created_time,\n    f.size AS size_bytes\nFROM\n    file f\nLEFT JOIN\n    users u ON f.uid = u.uid\nLEFT JOIN\n    groups g ON f.gid = g.gid\nWHERE\n    (f.path LIKE \"/run/systemd/system/%\"\n    OR f.path LIKE \"/etc/systemd/system/%\"\n    OR f.path LIKE \"/etc/systemd/user/%\"\n    OR f.path LIKE \"/usr/local/lib/systemd/system/%\"\n    OR f.path LIKE \"/lib/systemd/system/%\"\n    OR f.path LIKE \"/usr/lib/systemd/system/%\"\n    OR f.path LIKE \"/usr/lib/systemd/user/%\"\n    OR f.path LIKE \"/home/%/.config/systemd/user/%\"\n    OR f.path LIKE \"/home/%/.local/share/systemd/user/%\")\n    AND f.filename LIKE \"%.service\"\n","SELECT\n    f.filename,\n    f.path,\n    u.username AS file_owner,\n    g.groupname AS group_owner,\n    datetime(f.atime, 'unixepoch') AS file_last_access_time,\n    datetime(f.mtime, 'unixepoch') AS file_last_modified_time,\n    datetime(f.ctime, 'unixepoch') AS file_last_status_change_time,\n    datetime(f.btime, 'unixepoch') AS file_created_time,\n    f.size AS size_bytes,\n    h.md5\nFROM\n    file f\nLEFT JOIN\n    users u ON f.uid = u.uid\nLEFT JOIN\n    groups g ON f.gid = g.gid\nLEFT JOIN\n    hash h ON f.path = h.path\nWHERE\n    f.directory IN (\n        '/run/systemd/system',\n        '/etc/systemd/system',\n        '/etc/systemd/user',\n        '/usr/local/lib/systemd/system',\n        '/lib/systemd/system',\n        '/usr/lib/systemd/system',\n        '/usr/lib/systemd/user',\n        '/home/.config/systemd/user',\n        '/home/.local/share/systemd/user'\n    )\n    AND f.filename LIKE \"%.timer\"\nORDER BY\n    f.mtime DESC;\n","SELECT\n    f.filename,\n    f.path,\n    u.username AS file_owner,\n    g.groupname AS group_owner,\n    datetime(f.atime, 'unixepoch') AS file_last_access_time,\n    datetime(f.mtime, 'unixepoch') AS file_last modified_time,\n    datetime(f.ctime, 'unixepoch') AS file_last_status_change_time,\n    datetime(f.btime, 'unixepoch') AS file_created_time,\n    f.size AS size_bytes,\n    h.md5\nFROM\n    file f\nLEFT JOIN\n    users u ON f.uid = u.uid\nLEFT JOIN\n    groups g ON f.gid = g.gid\nLEFT JOIN\n    hash h ON f.path = h.path\nWHERE\n    f.directory IN (\n        '/etc/systemd/system-generators/',\n        '/usr/local/lib/systemd/system-generators/',\n        '/lib/systemd/system-generators/',\n        '/etc/systemd/user-generators/',\n        '/usr/local/lib/systemd/user-generators/',\n        '/usr/lib/systemd/user-generators/'\n    )\nORDER BY\n    f.mtime DESC;\n","SELECT name, path, source, status, type FROM startup_items\nWHERE type == \"systemd unit\" AND status == \"active\" AND\nname LIKE \"%.service\" OR name LIKE  \"%.timer\"\n"]},"rule":{"tags":["Hunt Type: Hunt"],"query":["from logs-endpoint.events.file-*\n| where @timestamp > now() - 30 day\n| where host.os.type == \"linux\" and event.type in (\"creation\", \"change\") and (\n\n    // System-wide/user-specific services/timers (root permissions required)\n    file.path like \"/run/systemd/system/*\" or\n    file.path like \"/etc/systemd/system/*\" or\n    file.path like \"/etc/systemd/user/*\" or\n    file.path like \"/usr/local/lib/systemd/system/*\" or\n    file.path like \"/lib/systemd/system/*\" or\n    file.path like \"/usr/lib/systemd/system/*\" or\n    file.path like \"/usr/lib/systemd/user/*\" or\n\n    // user-specific services/timers (user permissions required)\n    file.path like \"/home/*/.config/systemd/user/*\" or\n    file.path like \"/home/*/.local/share/systemd/user/*\" or\n\n    // System-wide generators (root permissions required)\n    file.path like \"/etc/systemd/system-generators/*\" or\n    file.path like \"/usr/local/lib/systemd/system-generators/*\" or\n    file.path like \"/lib/systemd/system-generators/*\" or\n    file.path like \"/etc/systemd/user-generators/*\" or\n    file.path like \"/usr/local/lib/systemd/user-generators/*\" or\n    file.path like \"/usr/lib/systemd/user-generators/*\"\n\n) and not (\n    process.name in (\n      \"dpkg\", \"dockerd\", \"yum\", \"dnf\", \"snapd\", \"pacman\", \"pamac-daemon\",\n      \"netplan\", \"systemd\", \"generate\"\n    ) or\n    process.executable == \"/proc/self/exe\" or\n    process.executable like \"/dev/fd/*\" or\n    file.extension in (\"dpkg-remove\", \"swx\", \"swp\")\n)\n| eval persistence = case(\n\n    // System-wide/user-specific services/timers (root permissions required)\n    file.path like \"/run/systemd/system/*\" or\n    file.path like \"/etc/systemd/system/*\" or\n    file.path like \"/etc/systemd/user/*\" or\n    file.path like \"/usr/local/lib/systemd/system/*\" or\n    file.path like \"/lib/systemd/system/*\" or\n    file.path like \"/usr/lib/systemd/system/*\" or\n    file.path like \"/usr/lib/systemd/user/*\" or\n\n    // user-specific services/timers (user permissions required)\n    file.path like \"/home/*/.config/systemd/user/*\" or\n    file.path like \"/home/*/.local/share/systemd/user/*\" or\n\n    // System-wide generators (root permissions required)\n    file.path like \"/etc/systemd/system-generators/*\" or\n    file.path like \"/usr/local/lib/systemd/system-generators/*\" or\n    file.path like \"/lib/systemd/system-generators/*\" or\n    file.path like \"/etc/systemd/user-generators/*\" or\n    file.path like \"/usr/local/lib/systemd/user-generators/*\" or\n    file.path like \"/usr/lib/systemd/user-generators/*\",\n    process.name,\n    null\n)\n| stats pers_count = count(persistence) by process.executable, file.path\n| where pers_count > 0 and pers_count <= 20\n| sort pers_count asc\n| limit 100\n","SELECT\n    f.filename,\n    f.path,\n    u.username AS file_owner,\n    g.groupname AS group_owner,\n    datetime(f.atime, 'unixepoch') AS file_last_access_time,\n    datetime(f.mtime, 'unixepoch') AS file_last_modified_time,\n    datetime(f.ctime, 'unixepoch') AS file_last_status_change_time,\n    datetime(f.btime, 'unixepoch') AS file_created_time,\n    f.size AS size_bytes\nFROM\n    file f\nLEFT JOIN\n    users u ON f.uid = u.uid\nLEFT JOIN\n    groups g ON f.gid = g.gid\nWHERE\n    (f.path LIKE \"/run/systemd/system/%\"\n    OR f.path LIKE \"/etc/systemd/system/%\"\n    OR f.path LIKE \"/etc/systemd/user/%\"\n    OR f.path LIKE \"/usr/local/lib/systemd/system/%\"\n    OR f.path LIKE \"/lib/systemd/system/%\"\n    OR f.path LIKE \"/usr/lib/systemd/system/%\"\n    OR f.path LIKE \"/usr/lib/systemd/user/%\"\n    OR f.path LIKE \"/home/%/.config/systemd/user/%\"\n    OR f.path LIKE \"/home/%/.local/share/systemd/user/%\")\n    AND f.filename LIKE \"%.service\"\n","SELECT\n    f.filename,\n    f.path,\n    u.username AS file_owner,\n    g.groupname AS group_owner,\n    datetime(f.atime, 'unixepoch') AS file_last_access_time,\n    datetime(f.mtime, 'unixepoch') AS file_last_modified_time,\n    datetime(f.ctime, 'unixepoch') AS file_last_status_change_time,\n    datetime(f.btime, 'unixepoch') AS file_created_time,\n    f.size AS size_bytes,\n    h.md5\nFROM\n    file f\nLEFT JOIN\n    users u ON f.uid = u.uid\nLEFT JOIN\n    groups g ON f.gid = g.gid\nLEFT JOIN\n    hash h ON f.path = h.path\nWHERE\n    f.directory IN (\n        '/run/systemd/system',\n        '/etc/systemd/system',\n        '/etc/systemd/user',\n        '/usr/local/lib/systemd/system',\n        '/lib/systemd/system',\n        '/usr/lib/systemd/system',\n        '/usr/lib/systemd/user',\n        '/home/.config/systemd/user',\n        '/home/.local/share/systemd/user'\n    )\n    AND f.filename LIKE \"%.timer\"\nORDER BY\n    f.mtime DESC;\n","SELECT\n    f.filename,\n    f.path,\n    u.username AS file_owner,\n    g.groupname AS group_owner,\n    datetime(f.atime, 'unixepoch') AS file_last_access_time,\n    datetime(f.mtime, 'unixepoch') AS file_last modified_time,\n    datetime(f.ctime, 'unixepoch') AS file_last_status_change_time,\n    datetime(f.btime, 'unixepoch') AS file_created_time,\n    f.size AS size_bytes,\n    h.md5\nFROM\n    file f\nLEFT JOIN\n    users u ON f.uid = u.uid\nLEFT JOIN\n    groups g ON f.gid = g.gid\nLEFT JOIN\n    hash h ON f.path = h.path\nWHERE\n    f.directory IN (\n        '/etc/systemd/system-generators/',\n        '/usr/local/lib/systemd/system-generators/',\n        '/lib/systemd/system-generators/',\n        '/etc/systemd/user-generators/',\n        '/usr/local/lib/systemd/user-generators/',\n        '/usr/lib/systemd/user-generators/'\n    )\nORDER BY\n    f.mtime DESC;\n","SELECT name, path, source, status, type FROM startup_items\nWHERE type == \"systemd unit\" AND status == \"active\" AND\nname LIKE \"%.service\" OR name LIKE  \"%.timer\"\n"],"license":"Elastic License v2","description":"This hunt identifies potential persistence mechanisms via systemd (timers) on Linux systems. It monitors for file creation or modification events related to systemd service and timer configurations, as well as generators, which can indicate attempts to establish persistence through scheduled tasks.\n","threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"","name":"","reference":""},"technique":[{"id":"T1053","name":"","reference":"https://attack.mitre.org/techniques/T1053/","subtechnique":[{"id":"T1053.005","reference":"https://attack.mitre.org/techniques/T1053/005/"}]},{"id":"T1546","name":"","reference":"https://attack.mitre.org/techniques/T1546/","subtechnique":[{"id":"T1546.002","reference":"https://attack.mitre.org/techniques/T1546/002/"}]}]}]},"metadata":{"creation_date":"1970-01-01T00:00:00.000Z","updated_date":"1970-01-01T00:00:00.000Z","integration":["endpoint"]}}},"__N_SSG":true}