{"pageProps":{"rule":{"hunt":{"author":"Elastic","description":"This hunt identifies potential persistence mechanisms via the message-of-the-day (motd) on Linux systems. It monitors for file creation or modification events in the /etc/update-motd.d directory and processes started by these motd scripts. These scripts launch on SSH/terminal connection events, and execute the scripts as root. These activities can indicate attempts to establish persistence through motd modifications.\n","integration":["endpoint"],"uuid":"5984a354-d76c-43e6-bdd9-228456f1b371","name":"Persistence via Message-of-the-Day","language":["ES|QL","SQL"],"license":"Elastic License v2","notes":["This hunt includes multiple ES|QL and OSQuery queries to identify potential persistence mechanisms via the message-of-the-day (motd) on Linux systems.","Detects file creation or modification events in the /etc/update-motd.d directory, which is used for message-of-the-day scripts.","Excludes common legitimate processes to minimize false positives.","Uses EVAL to tag potential persistence events and counts occurrences to identify unusual activity.","Monitors processes started by motd scripts to detect potential persistence mechanisms.","OSQuery query is provided to complement the detection by retrieving detailed file information related to motd scripts."],"mitre":["T1036.005","T1546.003"],"query":["from logs-endpoint.events.file-*\n| where @timestamp > now() - 30 day\n| where host.os.type == \"linux\" and event.type in (\"creation\", \"change\") and file.path like \"/etc/update-motd.d/*\" and\nnot process.name in (\"dpkg\", \"dockerd\", \"yum\", \"dnf\", \"snapd\", \"pacman\")\n| eval persistence = case(file.path like \"/etc/update-motd.d/*\", process.name, null)\n| stats pers_count = count(persistence), agent_count = count_distinct(agent.id) by process.executable, file.path\n| where pers_count > 0 and pers_count <= 20 and agent_count <= 5\n| sort pers_count asc\n| limit 100\n","from logs-endpoint.events.process-*\n| where @timestamp > now() - 30 day\n| where host.os.type == \"linux\" and event.action == \"exec\" and event.type == \"start\" and process.parent.executable like \"/etc/update-motd.d/*\" and\nnot process.args like \"/tmp/tmp.*\"\n| stats cc = count(), host_count = count_distinct(host.name) by process.executable, process.parent.executable\n| where host_count <= 5\n| sort cc asc\n| limit 100\n","SELECT\n    f.filename,\n    f.path,\n    u.username AS file_owner,\n    g.groupname AS group_owner,\n    datetime(f.atime, 'unixepoch') AS file_last_access_time,\n    datetime(f.mtime, 'unixepoch') AS file_last_modified_time,\n    datetime(f.ctime, 'unixepoch') AS file_last_status_change_time,\n    datetime(f.btime, 'unixepoch') AS file_created_time,\n    f.size AS size_bytes,\n    h.md5\nFROM\n    file f\nLEFT JOIN\n    users u ON f.uid = u.uid\nLEFT JOIN\n    groups g ON f.gid = g.gid\nLEFT JOIN\n    hash h ON f.path = h.path\nWHERE\n    f.directory IN ('/etc/update-motd.d/')\nORDER BY\n    f.mtime DESC;\n"]},"rule":{"tags":["Hunt Type: Hunt"],"query":["from logs-endpoint.events.file-*\n| where @timestamp > now() - 30 day\n| where host.os.type == \"linux\" and event.type in (\"creation\", \"change\") and file.path like \"/etc/update-motd.d/*\" and\nnot process.name in (\"dpkg\", \"dockerd\", \"yum\", \"dnf\", \"snapd\", \"pacman\")\n| eval persistence = case(file.path like \"/etc/update-motd.d/*\", process.name, null)\n| stats pers_count = count(persistence), agent_count = count_distinct(agent.id) by process.executable, file.path\n| where pers_count > 0 and pers_count <= 20 and agent_count <= 5\n| sort pers_count asc\n| limit 100\n","from logs-endpoint.events.process-*\n| where @timestamp > now() - 30 day\n| where host.os.type == \"linux\" and event.action == \"exec\" and event.type == \"start\" and process.parent.executable like \"/etc/update-motd.d/*\" and\nnot process.args like \"/tmp/tmp.*\"\n| stats cc = count(), host_count = count_distinct(host.name) by process.executable, process.parent.executable\n| where host_count <= 5\n| sort cc asc\n| limit 100\n","SELECT\n    f.filename,\n    f.path,\n    u.username AS file_owner,\n    g.groupname AS group_owner,\n    datetime(f.atime, 'unixepoch') AS file_last_access_time,\n    datetime(f.mtime, 'unixepoch') AS file_last_modified_time,\n    datetime(f.ctime, 'unixepoch') AS file_last_status_change_time,\n    datetime(f.btime, 'unixepoch') AS file_created_time,\n    f.size AS size_bytes,\n    h.md5\nFROM\n    file f\nLEFT JOIN\n    users u ON f.uid = u.uid\nLEFT JOIN\n    groups g ON f.gid = g.gid\nLEFT JOIN\n    hash h ON f.path = h.path\nWHERE\n    f.directory IN ('/etc/update-motd.d/')\nORDER BY\n    f.mtime DESC;\n"],"license":"Elastic License v2","description":"This hunt identifies potential persistence mechanisms via the message-of-the-day (motd) on Linux systems. It monitors for file creation or modification events in the /etc/update-motd.d directory and processes started by these motd scripts. These scripts launch on SSH/terminal connection events, and execute the scripts as root. These activities can indicate attempts to establish persistence through motd modifications.\n","threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"","name":"","reference":""},"technique":[{"id":"T1036","name":"","reference":"https://attack.mitre.org/techniques/T1036/","subtechnique":[{"id":"T1036.005","reference":"https://attack.mitre.org/techniques/T1036/005/"}]},{"id":"T1546","name":"","reference":"https://attack.mitre.org/techniques/T1546/","subtechnique":[{"id":"T1546.003","reference":"https://attack.mitre.org/techniques/T1546/003/"}]}]}]},"metadata":{"creation_date":"1970-01-01T00:00:00.000Z","updated_date":"1970-01-01T00:00:00.000Z","integration":["endpoint"]}}},"__N_SSG":true}