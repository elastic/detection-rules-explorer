{"pageProps":{"rule":{"hunt":{"author":"Elastic","description":"This hunt looks for a high number of executable file transfers via the SMB protocol by the same user or agent to more than a defined maxium threshold of targets. This could be a sign of lateral movement via the Windows Admin Shares.\n","integration":["endpoint"],"uuid":"814894a4-c951-4f33-ab0b-09354e1cb957","name":"PE File Transfer via SMB_Admin Shares by Agent or User","language":["ES|QL"],"license":"Elastic License v2","notes":["Further investigation can done pivoting by `host.id` and `user.name`."],"mitre":["T1021","T1021.002"],"query":["from logs-endpoint.events.file-*\n| where  @timestamp > now() - 7 day\n| where host.os.family == \"windows\" and event.category == \"file\" and event.action != \"deletion\" and process.pid == 4 and\n  starts_with(file.Ext.header_bytes, \"4d5a*\") and (starts_with(user.id, \"S-1-5-21-\") or starts_with(user.id, \"S-1-12-1-\"))\n| stats agents = count_distinct(host.id), total = count(*) by user.name\n| where agents == 1 and total <= 3\n","from logs-endpoint.events.file-*\n| where  @timestamp > now() - 7 day\n| where host.os.family == \"windows\" and event.category == \"file\" and event.action != \"deletion\" and process.pid == 4 and\n  starts_with(file.Ext.header_bytes, \"4d5a*\") and (starts_with(user.id, \"S-1-5-21-\") or starts_with(user.id, \"S-1-12-1-\"))\n| stats agents = count_distinct(host.id), total = count(*) by user.name\n /* threshold set to 10 but can be adjusted to reduce normal baseline in your env */\n| where agents >= 10\n"]},"rule":{"tags":["Hunt Type: Hunt"],"query":["from logs-endpoint.events.file-*\n| where  @timestamp > now() - 7 day\n| where host.os.family == \"windows\" and event.category == \"file\" and event.action != \"deletion\" and process.pid == 4 and\n  starts_with(file.Ext.header_bytes, \"4d5a*\") and (starts_with(user.id, \"S-1-5-21-\") or starts_with(user.id, \"S-1-12-1-\"))\n| stats agents = count_distinct(host.id), total = count(*) by user.name\n| where agents == 1 and total <= 3\n","from logs-endpoint.events.file-*\n| where  @timestamp > now() - 7 day\n| where host.os.family == \"windows\" and event.category == \"file\" and event.action != \"deletion\" and process.pid == 4 and\n  starts_with(file.Ext.header_bytes, \"4d5a*\") and (starts_with(user.id, \"S-1-5-21-\") or starts_with(user.id, \"S-1-12-1-\"))\n| stats agents = count_distinct(host.id), total = count(*) by user.name\n /* threshold set to 10 but can be adjusted to reduce normal baseline in your env */\n| where agents >= 10\n"],"license":"Elastic License v2","description":"This hunt looks for a high number of executable file transfers via the SMB protocol by the same user or agent to more than a defined maxium threshold of targets. This could be a sign of lateral movement via the Windows Admin Shares.\n","threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"","name":"","reference":""},"technique":[{"id":"T1021","name":"","reference":"https://attack.mitre.org/techniques/T1021/"},{"id":"T1021","name":"","reference":"https://attack.mitre.org/techniques/T1021/","subtechnique":[{"id":"T1021.002","reference":"https://attack.mitre.org/techniques/T1021/002/"}]}]}]},"metadata":{"creation_date":"1970-01-01T00:00:00.000Z","updated_date":"1970-01-01T00:00:00.000Z","integration":["endpoint"]}}},"__N_SSG":true}