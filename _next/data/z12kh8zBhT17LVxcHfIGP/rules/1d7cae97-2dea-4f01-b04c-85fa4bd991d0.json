{"pageProps":{"rule":{"hunt":{"author":"Elastic","description":"This hunt identifies potential persistence mechanisms leveraging DPKG or RPM package managers on Linux systems. These tools, used for installing and managing software, can be exploited by attackers to execute malicious scripts or establish persistence via lifecycle scripts (preinst, postinst, prerm, postrm). This hunt focuses on detecting suspicious file creations and anomalous process activity related to these package managers.\n","integration":["endpoint"],"uuid":"1d7cae97-2dea-4f01-b04c-85fa4bd991d0","name":"Persistence via DPKG/RPM Package","language":["ES|QL","SQL"],"license":"Elastic License v2","notes":["Monitors for the creation or renaming of files in directories associated with DPKG and RPM package managers, such as /var/lib/dpkg/info/ and /var/lib/rpm/.","Excludes common benign file patterns (e.g., temporary files, checksum files, or list files) to reduce noise while detecting unusual modifications.","Analyzes processes executed from lifecycle scripts or directories associated with package managers, such as /var/tmp/rpm-tmp.* and /var/lib/dpkg/info/*.","Uses OSQuery queries to gather detailed metadata on files and directories modified by package management activities for forensic analysis.","Provides counts and statistics to help highlight rare or unusual package management-related activity."],"mitre":["T1546.016"],"query":["from logs-endpoint.events.file-*\n| keep @timestamp, host.os.type, event.action, file.path, file.name, agent.id, process.executable\n| where @timestamp > now() - 7 days\n| where host.os.type == \"linux\" and event.action in (\"rename\", \"creation\") and (\n  file.path like \"/var/lib/dpkg/info/*\" or\n  file.path like \"/var/lib/rpm/*\"\n) and not (\n  // Remove these exclusions if you have a high suspicion of this activity\n  // Add additional exclusions here if necessary based on your environment\n  file.name like \"*-new\" or\n  file.name like \"__db*.*\" or\n  file.name like \"*.list\" or\n  file.name like \"*.md5sums*\"\n)\n| stats cc = count(), agent_count = count_distinct(agent.id) by file.name, process.executable\n| where agent_count <= 3\n| sort cc asc\n| limit 100\n","from logs-endpoint.events.process-*\n| keep @timestamp, host.os.type, event.type, event.action, process.parent.command_line, process.parent.executable, agent.id, process.executable, process.command_line\n| where @timestamp > now() - 7 days\n| where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and (\n  process.parent.command_line like \"*/var/tmp/rpm-tmp.*\" or\n  process.parent.executable like \"/var/lib/dpkg/info/*\"\n)\n| stats cc = count(), agent_count = count_distinct(agent.id) by process.executable, process.command_line\n| where agent_count <= 3\n| sort cc asc\n| limit 100\n","SELECT\n    f.filename,\n    f.path,\n    u.username AS file_owner,\n    g.groupname AS group_owner,\n    datetime(f.atime, 'unixepoch') AS file_last_access_time,\n    datetime(f.mtime, 'unixepoch') AS file_last_modified_time,\n    datetime(f.ctime, 'unixepoch') AS file_last_status_change_time,\n    datetime(f.btime, 'unixepoch') AS file_created_time,\n    f.size AS size_bytes\nFROM\n    file f\nLEFT JOIN\n    users u ON f.uid = u.uid\nLEFT JOIN\n    groups g ON f.gid = g.gid\nWHERE (\n        f.path LIKE '/var/lib/dpkg/info/%'\n        OR f.path LIKE '/var/lib/rpm/%'\n      )\nAND (mtime > strftime('%s', 'now') - (7 * 86400)); -- Modified in the last 7 days\n"]},"rule":{"tags":["Hunt Type: Hunt"],"query":["from logs-endpoint.events.file-*\n| keep @timestamp, host.os.type, event.action, file.path, file.name, agent.id, process.executable\n| where @timestamp > now() - 7 days\n| where host.os.type == \"linux\" and event.action in (\"rename\", \"creation\") and (\n  file.path like \"/var/lib/dpkg/info/*\" or\n  file.path like \"/var/lib/rpm/*\"\n) and not (\n  // Remove these exclusions if you have a high suspicion of this activity\n  // Add additional exclusions here if necessary based on your environment\n  file.name like \"*-new\" or\n  file.name like \"__db*.*\" or\n  file.name like \"*.list\" or\n  file.name like \"*.md5sums*\"\n)\n| stats cc = count(), agent_count = count_distinct(agent.id) by file.name, process.executable\n| where agent_count <= 3\n| sort cc asc\n| limit 100\n","from logs-endpoint.events.process-*\n| keep @timestamp, host.os.type, event.type, event.action, process.parent.command_line, process.parent.executable, agent.id, process.executable, process.command_line\n| where @timestamp > now() - 7 days\n| where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and (\n  process.parent.command_line like \"*/var/tmp/rpm-tmp.*\" or\n  process.parent.executable like \"/var/lib/dpkg/info/*\"\n)\n| stats cc = count(), agent_count = count_distinct(agent.id) by process.executable, process.command_line\n| where agent_count <= 3\n| sort cc asc\n| limit 100\n","SELECT\n    f.filename,\n    f.path,\n    u.username AS file_owner,\n    g.groupname AS group_owner,\n    datetime(f.atime, 'unixepoch') AS file_last_access_time,\n    datetime(f.mtime, 'unixepoch') AS file_last_modified_time,\n    datetime(f.ctime, 'unixepoch') AS file_last_status_change_time,\n    datetime(f.btime, 'unixepoch') AS file_created_time,\n    f.size AS size_bytes\nFROM\n    file f\nLEFT JOIN\n    users u ON f.uid = u.uid\nLEFT JOIN\n    groups g ON f.gid = g.gid\nWHERE (\n        f.path LIKE '/var/lib/dpkg/info/%'\n        OR f.path LIKE '/var/lib/rpm/%'\n      )\nAND (mtime > strftime('%s', 'now') - (7 * 86400)); -- Modified in the last 7 days\n"],"license":"Elastic License v2","description":"This hunt identifies potential persistence mechanisms leveraging DPKG or RPM package managers on Linux systems. These tools, used for installing and managing software, can be exploited by attackers to execute malicious scripts or establish persistence via lifecycle scripts (preinst, postinst, prerm, postrm). This hunt focuses on detecting suspicious file creations and anomalous process activity related to these package managers.\n","threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"","name":"","reference":""},"technique":[{"id":"T1546","name":"","reference":"https://attack.mitre.org/techniques/T1546/","subtechnique":[{"id":"T1546.016","reference":"https://attack.mitre.org/techniques/T1546/016/"}]}]}]},"metadata":{"creation_date":"1970-01-01T00:00:00.000Z","updated_date":"1970-01-01T00:00:00.000Z","integration":["endpoint"]}}},"__N_SSG":true}