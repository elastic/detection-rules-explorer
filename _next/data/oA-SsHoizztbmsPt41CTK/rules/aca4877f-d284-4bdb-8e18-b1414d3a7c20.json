{"pageProps":{"rule":{"hunt":{"author":"Elastic","description":"This hunt looks for unusual Microsoft native processes spawning `cmd.exe`, `powershell.exe` or `conhost.exe` and limited to a unique host. This could be normal rare behavior as well as an interactive shell activity from an injected parent process to execute system commands.\n","integration":["endpoint","windows","system"],"uuid":"aca4877f-d284-4bdb-8e18-b1414d3a7c20","name":"Windows Command and Scripting Interpreter from Unusual Parent Process","language":["ES|QL"],"license":"Elastic License v2","notes":["Further pivoting can be done via `process.parent.name`.","Certain Microsoft binaries like LSASS, winlogon, spoolsv and others should never spawn `cmd.exe`, `powershell.exe` or `conhost.exe`, if so it's highly likely malicious."],"mitre":["T1059","T1059.001","T1059.003"],"query":["from logs-endpoint.events.process-*, logs-windows.sysmon_operational-*, logs-system.security-*\n| where  @timestamp > now() - 7 day\n| where host.os.family == \"windows\" and event.category == \"process\" and event.action in (\"start\", \"Process creation\", \"created-process\") and\n  to_lower(process.name) in (\"cmd.exe\", \"powershell.exe\", \"conhost.exe\") and\n  (starts_with(to_lower(process.parent.executable), \"c:\\\\windows\\\\system32\") or starts_with(to_lower(process.parent.executable), \"c:\\\\windows\\\\syswow64\"))\n| keep process.name, process.parent.name, host.id\n| stats hosts = count_distinct(host.id), cc = count(*) by process.parent.name\n| where cc <= 10 and hosts == 1\n"]},"rule":{"tags":["Hunt Type: Hunt"],"query":["from logs-endpoint.events.process-*, logs-windows.sysmon_operational-*, logs-system.security-*\n| where  @timestamp > now() - 7 day\n| where host.os.family == \"windows\" and event.category == \"process\" and event.action in (\"start\", \"Process creation\", \"created-process\") and\n  to_lower(process.name) in (\"cmd.exe\", \"powershell.exe\", \"conhost.exe\") and\n  (starts_with(to_lower(process.parent.executable), \"c:\\\\windows\\\\system32\") or starts_with(to_lower(process.parent.executable), \"c:\\\\windows\\\\syswow64\"))\n| keep process.name, process.parent.name, host.id\n| stats hosts = count_distinct(host.id), cc = count(*) by process.parent.name\n| where cc <= 10 and hosts == 1\n"],"license":"Elastic License v2","description":"This hunt looks for unusual Microsoft native processes spawning `cmd.exe`, `powershell.exe` or `conhost.exe` and limited to a unique host. This could be normal rare behavior as well as an interactive shell activity from an injected parent process to execute system commands.\n","threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"","name":"","reference":""},"technique":[{"id":"T1059","name":"","reference":"https://attack.mitre.org/techniques/T1059/"},{"id":"T1059","name":"","reference":"https://attack.mitre.org/techniques/T1059/","subtechnique":[{"id":"T1059.001","reference":"https://attack.mitre.org/techniques/T1059/001/"}]},{"id":"T1059","name":"","reference":"https://attack.mitre.org/techniques/T1059/","subtechnique":[{"id":"T1059.003","reference":"https://attack.mitre.org/techniques/T1059/003/"}]}]}]},"metadata":{"creation_date":"1970-01-01T00:00:00.000Z","updated_date":"1970-01-01T00:00:00.000Z","integration":["endpoint","windows","system"]}}},"__N_SSG":true}