{"pageProps":{"rule":{"hunt":{"author":"Elastic","description":"This hunt aggregates created Windows services by service file name and distribution limited to unique hosts. Using the ES|QL `Replace` command we can also further remove random patterns to reduce results to interesting events. More investigation can be conducted on instance that looks suspicious based on service file path, names and LOLBins.\n","integration":["endpoint","windows","system"],"uuid":"48b75e53-3c73-40bd-873d-569dd8d7d925","name":"Unique Windows Services Creation by Service File Name","language":["ES|QL"],"license":"Elastic License v2","notes":["This hunt also identifies services registry modification by unusual process based on number of hosts and occurrences history.","Windows event IDs 4697 and 7045 are used to identify service creation and modification."],"mitre":["T1543","T1543.003"],"query":["from logs-endpoint.events.registry-*, logs-windows.sysmon_operational-*\n| where  @timestamp > now() - 7 day\n| where host.os.family == \"windows\" and event.category == \"registry\" and event.action in (\"modification\",  \"RegistryEvent (Value Set)\") and\n  registry.value in (\"ServiceDLL\", \"ImagePath\") and starts_with(registry.path, \"HKLM\\\\SYSTEM\\\\\") and\n  process.executable != \"C:\\\\Windows\\\\System32\\\\services.exe\"\n| eval process_path = replace(process.executable, \"\"\"[cC]:\\\\[uU][sS][eE][rR][sS]\\\\[a-zA-Z0-9ñ\\.\\-\\_\\$~ ]+\\\\\"\"\", \"C:\\\\\\\\users\\\\\\\\user\\\\\\\\\")\n| stats hosts = count_distinct(host.id), occurrences = count(*) by process_path\n/* unique process.executable found in one agent */\n| where hosts == 1 and occurrences == 1\n","from logs-endpoint.events.registry-*, logs-windows.sysmon_operational-*\n| where  @timestamp > now() - 7 day\n| where host.os.family == \"windows\" and event.category == \"registry\" and event.action in (\"modification\",  \"RegistryEvent (Value Set)\") and\n  registry.value in (\"ServiceDLL\", \"ImagePath\") and starts_with(registry.path, \"HKLM\\\\SYSTEM\\\\\") and\n  not registry.data.strings rlike \"\"\"(.{1,2}[c-fC-F]:\\\\Program Files.+)|([c-fC-F]:\\\\Program Files.+)|(.*\\\\System32\\\\DriverStore\\\\FileRepository\\\\.+)\"\"\"\n| eval ServiceFileName = replace(registry.data.strings, \"\"\"([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}|ns[a-z][A-Z0-9]{3,4}\\.tmp|DX[A-Z0-9]{3,4}\\.tmp|7z[A-Z0-9]{3,5}\\.tmp|[0-9\\.\\-\\_]{3,})\"\"\", \"\")\n| eval ServiceFileName = replace(ServiceFileName, \"\"\".inf_amd[a-z0-9]{5,}\\\\\"\"\", \"_replaced_\")\n| eval ServiceFileName = replace(ServiceFileName, \"\"\"[cC]:\\\\[uU][sS][eE][rR][sS]\\\\[a-zA-Z0-9ñ\\.\\-\\_\\$~ ]+\\\\\"\"\", \"C:\\\\\\\\users\\\\\\\\user\\\\\\\\\")\n| stats cc = count(*), hosts = count_distinct(host.id) by ServiceFileName\n /* unique ServiceFileName observed in 1 host*/\n| where hosts == 1 and cc == 1\n","from logs-system.security-*\n| where  @timestamp > now() - 7 day\n| where host.os.family == \"windows\" and event.category == \"configuration\" and event.code == \"4697\" and\n  not winlog.event_data.ServiceFileName rlike \"\"\"(.{1,2}[c-fC-F]:\\\\Program Files.+)|([c-fC-F]:\\\\Program Files.+)|(.*\\\\System32\\\\DriverStore\\\\FileRepository\\\\.+)\"\"\"\n| eval ServiceFileName = replace(winlog.event_data.ServiceFileName, \"\"\"([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}|ns[a-z][A-Z0-9]{3,4}\\.tmp|DX[A-Z0-9]{3,4}\\.tmp|7z[A-Z0-9]{3,5}\\.tmp|[0-9\\.\\-\\_]{3,})\"\"\", \"\")\n| eval ServiceFileName = replace(ServiceFileName, \"\"\".inf_amd[a-z0-9]{5,}\\\\\"\"\", \"_replaced_\")\n| eval ServiceFileName = replace(ServiceFileName, \"\"\"[cC]:\\\\[uU][sS][eE][rR][sS]\\\\[a-zA-Z0-9ñ\\.\\-\\_\\$~ ]+\\\\\"\"\", \"C:\\\\\\\\users\\\\\\\\user\\\\\\\\\")\n| stats cc = count(*), hosts = count_distinct(host.id) by ServiceFileName\n| where hosts == 1 and cc == 1\n","from logs-system.system-*\n| where  @timestamp > now() - 7 day\n| where host.os.family == \"windows\" and event.code == \"7045\" and\n  not winlog.event_data.ImagePath rlike \"\"\"(.{1,2}[c-fC-F]:\\\\Program Files.+)|([c-fC-F]:\\\\Program Files.+)|(.*\\\\System32\\\\DriverStore\\\\FileRepository\\\\.+)\"\"\"\n| eval ServiceFileName = replace(winlog.event_data.ImagePath, \"\"\"([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}|ns[a-z][A-Z0-9]{3,4}\\.tmp|DX[A-Z0-9]{3,4}\\.tmp|7z[A-Z0-9]{3,5}\\.tmp|[0-9\\.\\-\\_]{3,})\"\"\", \"\")\n| eval ServiceFileName = replace(ServiceFileName, \"\"\".inf_amd[a-z0-9]{5,}\\\\\"\"\", \"_replaced_\")\n| eval ServiceFileName = replace(ServiceFileName, \"\"\"[cC]:\\\\[uU][sS][eE][rR][sS]\\\\[a-zA-Z0-9ñ\\.\\-\\_\\$~ ]+\\\\\"\"\", \"C:\\\\\\\\users\\\\\\\\user\\\\\\\\\")\n| stats cc = count(*), hosts = count_distinct(host.id) by ServiceFileName\n| where hosts == 1 and cc == 1\n"]},"rule":{"tags":["Hunt Type: Hunt"],"query":["from logs-endpoint.events.registry-*, logs-windows.sysmon_operational-*\n| where  @timestamp > now() - 7 day\n| where host.os.family == \"windows\" and event.category == \"registry\" and event.action in (\"modification\",  \"RegistryEvent (Value Set)\") and\n  registry.value in (\"ServiceDLL\", \"ImagePath\") and starts_with(registry.path, \"HKLM\\\\SYSTEM\\\\\") and\n  process.executable != \"C:\\\\Windows\\\\System32\\\\services.exe\"\n| eval process_path = replace(process.executable, \"\"\"[cC]:\\\\[uU][sS][eE][rR][sS]\\\\[a-zA-Z0-9ñ\\.\\-\\_\\$~ ]+\\\\\"\"\", \"C:\\\\\\\\users\\\\\\\\user\\\\\\\\\")\n| stats hosts = count_distinct(host.id), occurrences = count(*) by process_path\n/* unique process.executable found in one agent */\n| where hosts == 1 and occurrences == 1\n","from logs-endpoint.events.registry-*, logs-windows.sysmon_operational-*\n| where  @timestamp > now() - 7 day\n| where host.os.family == \"windows\" and event.category == \"registry\" and event.action in (\"modification\",  \"RegistryEvent (Value Set)\") and\n  registry.value in (\"ServiceDLL\", \"ImagePath\") and starts_with(registry.path, \"HKLM\\\\SYSTEM\\\\\") and\n  not registry.data.strings rlike \"\"\"(.{1,2}[c-fC-F]:\\\\Program Files.+)|([c-fC-F]:\\\\Program Files.+)|(.*\\\\System32\\\\DriverStore\\\\FileRepository\\\\.+)\"\"\"\n| eval ServiceFileName = replace(registry.data.strings, \"\"\"([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}|ns[a-z][A-Z0-9]{3,4}\\.tmp|DX[A-Z0-9]{3,4}\\.tmp|7z[A-Z0-9]{3,5}\\.tmp|[0-9\\.\\-\\_]{3,})\"\"\", \"\")\n| eval ServiceFileName = replace(ServiceFileName, \"\"\".inf_amd[a-z0-9]{5,}\\\\\"\"\", \"_replaced_\")\n| eval ServiceFileName = replace(ServiceFileName, \"\"\"[cC]:\\\\[uU][sS][eE][rR][sS]\\\\[a-zA-Z0-9ñ\\.\\-\\_\\$~ ]+\\\\\"\"\", \"C:\\\\\\\\users\\\\\\\\user\\\\\\\\\")\n| stats cc = count(*), hosts = count_distinct(host.id) by ServiceFileName\n /* unique ServiceFileName observed in 1 host*/\n| where hosts == 1 and cc == 1\n","from logs-system.security-*\n| where  @timestamp > now() - 7 day\n| where host.os.family == \"windows\" and event.category == \"configuration\" and event.code == \"4697\" and\n  not winlog.event_data.ServiceFileName rlike \"\"\"(.{1,2}[c-fC-F]:\\\\Program Files.+)|([c-fC-F]:\\\\Program Files.+)|(.*\\\\System32\\\\DriverStore\\\\FileRepository\\\\.+)\"\"\"\n| eval ServiceFileName = replace(winlog.event_data.ServiceFileName, \"\"\"([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}|ns[a-z][A-Z0-9]{3,4}\\.tmp|DX[A-Z0-9]{3,4}\\.tmp|7z[A-Z0-9]{3,5}\\.tmp|[0-9\\.\\-\\_]{3,})\"\"\", \"\")\n| eval ServiceFileName = replace(ServiceFileName, \"\"\".inf_amd[a-z0-9]{5,}\\\\\"\"\", \"_replaced_\")\n| eval ServiceFileName = replace(ServiceFileName, \"\"\"[cC]:\\\\[uU][sS][eE][rR][sS]\\\\[a-zA-Z0-9ñ\\.\\-\\_\\$~ ]+\\\\\"\"\", \"C:\\\\\\\\users\\\\\\\\user\\\\\\\\\")\n| stats cc = count(*), hosts = count_distinct(host.id) by ServiceFileName\n| where hosts == 1 and cc == 1\n","from logs-system.system-*\n| where  @timestamp > now() - 7 day\n| where host.os.family == \"windows\" and event.code == \"7045\" and\n  not winlog.event_data.ImagePath rlike \"\"\"(.{1,2}[c-fC-F]:\\\\Program Files.+)|([c-fC-F]:\\\\Program Files.+)|(.*\\\\System32\\\\DriverStore\\\\FileRepository\\\\.+)\"\"\"\n| eval ServiceFileName = replace(winlog.event_data.ImagePath, \"\"\"([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}|ns[a-z][A-Z0-9]{3,4}\\.tmp|DX[A-Z0-9]{3,4}\\.tmp|7z[A-Z0-9]{3,5}\\.tmp|[0-9\\.\\-\\_]{3,})\"\"\", \"\")\n| eval ServiceFileName = replace(ServiceFileName, \"\"\".inf_amd[a-z0-9]{5,}\\\\\"\"\", \"_replaced_\")\n| eval ServiceFileName = replace(ServiceFileName, \"\"\"[cC]:\\\\[uU][sS][eE][rR][sS]\\\\[a-zA-Z0-9ñ\\.\\-\\_\\$~ ]+\\\\\"\"\", \"C:\\\\\\\\users\\\\\\\\user\\\\\\\\\")\n| stats cc = count(*), hosts = count_distinct(host.id) by ServiceFileName\n| where hosts == 1 and cc == 1\n"],"license":"Elastic License v2","description":"This hunt aggregates created Windows services by service file name and distribution limited to unique hosts. Using the ES|QL `Replace` command we can also further remove random patterns to reduce results to interesting events. More investigation can be conducted on instance that looks suspicious based on service file path, names and LOLBins.\n","threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"","name":"","reference":""},"technique":[{"id":"T1543","name":"","reference":"https://attack.mitre.org/techniques/T1543/"},{"id":"T1543","name":"","reference":"https://attack.mitre.org/techniques/T1543/","subtechnique":[{"id":"T1543.003","reference":"https://attack.mitre.org/techniques/T1543/003/"}]}]}]},"metadata":{"creation_date":"1970-01-01T00:00:00.000Z","updated_date":"1970-01-01T00:00:00.000Z","integration":["endpoint","windows","system"]}}},"__N_SSG":true}