<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><title>Home</title><meta name="next-head-count" content="3"/><meta name="description" content="Detection Rules is the home for rules used by Elastic Security."/><meta property="og:title" content="Elastic Detection Rules"/><meta property="og:description" content="Detection Rules is the home for rules used by Elastic Security."/><meta property="og:url" content="https://github.com/elastic/detection-rules"/><link rel="stylesheet" href="/detection-rules-explorer/themes/eui_theme_dark.45c087c0a7ccec8a2229.min.css" data-name="eui-theme" data-theme-name="Dark" data-theme="dark" disabled="" aria-disabled="true"/><link rel="stylesheet" href="/detection-rules-explorer/themes/eui_theme_light.3de9904404a3ccaf0ed2.min.css" data-name="eui-theme" data-theme-name="Light" data-theme="light"/><link rel="icon" type="image/png" href="/detection-rules-explorer/images/favicon/prod/favicon-16x16.png" sizes="16x16"/><link rel="icon" type="image/png" href="/detection-rules-explorer/images/favicon/prod/favicon-32x32.png" sizes="32x32"/><link rel="icon" type="image/png" href="/detection-rules-explorer/images/favicon/prod/favicon-96x96.png" sizes="96x96"/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/detection-rules-explorer/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/detection-rules-explorer/_next/static/chunks/webpack-d444f824b18ba952.js" defer=""></script><script src="/detection-rules-explorer/_next/static/chunks/framework-79bce4a3a540b080.js" defer=""></script><script src="/detection-rules-explorer/_next/static/chunks/main-4be6f7e434f4c65e.js" defer=""></script><script src="/detection-rules-explorer/_next/static/chunks/pages/_app-f608ed562a5d9c84.js" defer=""></script><script src="/detection-rules-explorer/_next/static/chunks/4218-ffcd6b15488cdf6f.js" defer=""></script><script src="/detection-rules-explorer/_next/static/chunks/8738-e43f3c136aaac828.js" defer=""></script><script src="/detection-rules-explorer/_next/static/chunks/1304-34d1d6ab0f19548d.js" defer=""></script><script src="/detection-rules-explorer/_next/static/chunks/pages/rules/%5Bid%5D-0d03d4823d05b977.js" defer=""></script><script src="/detection-rules-explorer/_next/static/s1hqWXw4jXJXWFVds7Yqk/_buildManifest.js" defer=""></script><script src="/detection-rules-explorer/_next/static/s1hqWXw4jXJXWFVds7Yqk/_ssgManifest.js" defer=""></script></head><body class="guideBody"><div id="__next" data-reactroot=""><style data-emotion="css-global 2hgghz">#__next,.guideBody{min-height:100%;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;}</style><div class="euiHeader euiHeader--default euiHeader--fixed"><div class="euiHeaderSection euiHeaderSection--dontGrow euiHeaderSection--left"><div class="euiHeaderSectionItem"><a href="/detection-rules-explorer" class="eui-jxpcya"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" class="euiIcon eui-7yvbl4-euiIcon-l" role="img" aria-hidden="true"></svg><span class="euiTitle eui-z21xof-euiTitle-xxs">Elastic Security Detection Rules</span></a></div></div><div class="euiHeaderSection euiHeaderSection--dontGrow euiHeaderSection--left"><div class="euiHeaderSectionItem"><span class="euiToolTipAnchor eui-jcaat8-euiToolTipAnchor-inlineBlock"><button class="euiButtonEmpty euiHeaderSectionItemButton eui-wvaqcf-empty-text" type="button" aria-label="Change theme"><span class="euiButtonContent euiButtonEmpty__content"><span class="euiButtonEmpty__text"><span class="euiHeaderSectionItemButton__content"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" class="euiIcon eui-4394ro-euiIcon-m" role="img" aria-hidden="true"></svg></span></span></span></button></span></div><div class="euiHeaderSectionItem"><span class="euiToolTipAnchor eui-jcaat8-euiToolTipAnchor-inlineBlock"><a class="euiButtonEmpty euiHeaderSectionItemButton eui-wvaqcf-empty-text" href="https://github.com/elastic/detection-rules" rel="noreferrer" aria-label="EUI GitHub repo"><span class="euiButtonContent euiButtonEmpty__content"><span class="euiButtonEmpty__text"><span class="euiHeaderSectionItemButton__content"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" class="euiIcon eui-2txxin-euiIcon-m" role="img" aria-hidden="true"></svg></span></span></span></a></span></div></div></div><div class="eui-gok634"><div class="eui-1kqz3nm"><div class="euiFlexGroup euiFlexGroup--gutterLarge euiFlexGroup--directionRow euiFlexGroup--responsive eui-lw6o6k"><div class="euiFlexItem"><div class="euiPanel euiPanel--plain euiPanel--paddingMedium eui-1yzwxdg-euiPanel-grow-m-m-plain-hasShadow"><h1 class="euiTitle eui-smz32e-euiTitle-m">AWS EC2 Multi-Region DescribeInstances API Calls</h1><div class="euiSpacer euiSpacer--s eui-78drzl-euiSpacer-s"></div><div class="euiText eui-x1zygz-euiText-s-euiTextColor-subdued">Last updated <!-- -->a month ago<!-- --> on<!-- --> <!-- -->2024-11-07</div><div class="euiText eui-x1zygz-euiText-s-euiTextColor-subdued">Created <!-- -->3 months ago<!-- --> on<!-- --> <!-- -->2024-08-26</div></div></div></div><div class="euiFlexGroup euiFlexGroup--gutterLarge euiFlexGroup--directionRow euiFlexGroup--responsive eui-lw6o6k"><div class="euiFlexItem"><div class="euiPanel euiPanel--plain euiPanel--paddingMedium eui-1yzwxdg-euiPanel-grow-m-m-plain-hasShadow"><h1 class="euiTitle eui-smz32e-euiTitle-m">About</h1><div class="euiSpacer euiSpacer--l eui-p2o3x6-euiSpacer-l"></div><div class="euiText eui-1yivsv3-euiText-m">Identifies when a single AWS resource is making `DescribeInstances` API calls in more than 10 regions within a 30-second
window. This could indicate a potential threat actor attempting to discover the AWS infrastructure across multiple
regions using compromised credentials or a compromised instance. Adversaries may use this information to identify
potential targets for further exploitation or to gain a better understanding of the target&#x27;s infrastructure.
</div><div class="euiSpacer euiSpacer--l eui-p2o3x6-euiSpacer-l"></div><dl class="euiDescriptionList eui-12pc6e7-euiDescriptionList-column-left" data-type="column"><dt class="euiDescriptionList__title eui-nd7d6t-euiDescriptionList__title-column-m-normal">Tags</dt><dd class="euiDescriptionList__description eui-k4vc05-euiDescriptionList__description-column-normal-m"><span class="euiBadge eui-n49zn7-euiBadge" style="background-color:#ee789d;color:#000"><span class="euiBadge__content eui-1yj2yi7-euiBadge__content"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" class="euiIcon euiBadge__icon eui-1uiqggp-euiIcon-s-inherit-euiBadge__icon-left" role="img" aria-hidden="true"></svg><span class="euiBadge__text eui-1vg55k4-euiBadge__text">Domain: Cloud</span></span></span><span class="euiBadge eui-n49zn7-euiBadge" style="background-color:#D3DAE6;color:#000"><span class="euiBadge__content eui-1yj2yi7-euiBadge__content"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" class="euiIcon euiBadge__icon eui-1uiqggp-euiIcon-s-inherit-euiBadge__icon-left" role="img" aria-hidden="true"></svg><span class="euiBadge__text eui-1vg55k4-euiBadge__text">Data Source: AWS</span></span></span><span class="euiBadge eui-n49zn7-euiBadge" style="background-color:#D3DAE6;color:#000"><span class="euiBadge__content eui-1yj2yi7-euiBadge__content"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" class="euiIcon euiBadge__icon eui-1uiqggp-euiIcon-s-inherit-euiBadge__icon-left" role="img" aria-hidden="true"></svg><span class="euiBadge__text eui-1vg55k4-euiBadge__text">Data Source: AWS EC2</span></span></span><span class="euiBadge eui-n49zn7-euiBadge" style="background-color:#79aad9;color:#000"><span class="euiBadge__content eui-1yj2yi7-euiBadge__content"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" class="euiIcon euiBadge__icon eui-1uiqggp-euiIcon-s-inherit-euiBadge__icon-left" role="img" aria-hidden="true"></svg><span class="euiBadge__text eui-1vg55k4-euiBadge__text">Use Case: Threat Detection</span></span></span><span class="euiBadge eui-n49zn7-euiBadge" style="background-color:#f1d86f;color:#000"><span class="euiBadge__content eui-1yj2yi7-euiBadge__content"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" class="euiIcon euiBadge__icon eui-1uiqggp-euiIcon-s-inherit-euiBadge__icon-left" role="img" aria-hidden="true"></svg><span class="euiBadge__text eui-1vg55k4-euiBadge__text">Tactic: Discovery</span></span></span></dd><dt class="euiDescriptionList__title eui-nd7d6t-euiDescriptionList__title-column-m-normal">Severity</dt><dd class="euiDescriptionList__description eui-k4vc05-euiDescriptionList__description-column-normal-m"><div class="euiHealth eui-qn8ayk-euiHealth-s"><div class="euiFlexGroup euiFlexGroup--gutterExtraSmall euiFlexGroup--alignItemsCenter euiFlexGroup--directionRow"><div class="euiFlexItem euiFlexItem--flexGrowZero"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" class="euiIcon eui-1b2fr2v-euiIcon-m-subdued" role="img" aria-hidden="true"></svg></div><div class="euiFlexItem euiFlexItem--flexGrowZero">low</div></div></div></dd><dt class="euiDescriptionList__title eui-nd7d6t-euiDescriptionList__title-column-m-normal">Risk Score</dt><dd class="euiDescriptionList__description eui-k4vc05-euiDescriptionList__description-column-normal-m">21</dd><dt class="euiDescriptionList__title eui-nd7d6t-euiDescriptionList__title-column-m-normal">MITRE ATT&amp;CK™</dt><dd class="euiDescriptionList__description eui-k4vc05-euiDescriptionList__description-column-normal-m"><p><a class="euiLink eui-zxmf4e-euiLink-primary" href="https://attack.mitre.org/tactics/TA0007/" target="_blank" rel="noopener noreferrer">Discovery<!-- --> (<!-- -->TA0007<!-- -->)<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" class="euiIcon eui-1ed6zfh-euiIcon-s-euiLink__externalIcon" role="img" aria-label="External link" aria-hidden="true"></svg><span class="eui-194jjcc-euiScreenReaderOnly-euiLink__screenReaderText">(opens in a new tab or window)</span></a><div class="euiText eui-14lwe4a-euiText-xs"><p><a class="euiLink eui-zxmf4e-euiLink-primary" href="https://attack.mitre.org/techniques/T1580/" target="_blank" rel="noopener noreferrer">↳ <!-- -->Cloud Infrastructure Discovery<!-- --> (<!-- -->T1580<!-- -->)<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" class="euiIcon eui-1ed6zfh-euiIcon-s-euiLink__externalIcon" role="img" aria-label="External link" aria-hidden="true"></svg><span class="eui-194jjcc-euiScreenReaderOnly-euiLink__screenReaderText">(opens in a new tab or window)</span></a></p></div><div class="euiSpacer euiSpacer--xs eui-1wffcmx-euiSpacer-xs"></div></p></dd><dt class="euiDescriptionList__title eui-nd7d6t-euiDescriptionList__title-column-m-normal">False Positive Examples</dt><dd class="euiDescriptionList__description eui-k4vc05-euiDescriptionList__description-column-normal-m">    Legitimate use of the `DescribeInstances` API call by an AWS resource that requires information about instances in
    multiple regions.
    <!-- -->Scheduled tasks or scripts that require information about instances in multiple regions.</dd><dt class="euiDescriptionList__title eui-nd7d6t-euiDescriptionList__title-column-m-normal">License</dt><dd class="euiDescriptionList__description eui-k4vc05-euiDescriptionList__description-column-normal-m"><a class="euiLink eui-zxmf4e-euiLink-primary" href="https://www.elastic.co/licensing/elastic-license" target="_blank" rel="noopener">Elastic License v2<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" class="euiIcon eui-1ed6zfh-euiIcon-s-euiLink__externalIcon" role="img" aria-label="External link" aria-hidden="true"></svg><span class="eui-194jjcc-euiScreenReaderOnly-euiLink__screenReaderText">(opens in a new tab or window)</span></a></dd></dl></div></div><div class="euiFlexItem"><div class="euiPanel euiPanel--plain euiPanel--paddingMedium eui-1yzwxdg-euiPanel-grow-m-m-plain-hasShadow"><h1 class="euiTitle eui-smz32e-euiTitle-m">Definition</h1><div class="euiSpacer euiSpacer--l eui-p2o3x6-euiSpacer-l"></div><dl class="euiDescriptionList eui-12pc6e7-euiDescriptionList-column-left" data-type="column"><dt class="euiDescriptionList__title eui-nd7d6t-euiDescriptionList__title-column-m-normal">Integration Pack</dt><dd class="euiDescriptionList__description eui-k4vc05-euiDescriptionList__description-column-normal-m">Prebuilt Security Detection Rules</dd><dt class="euiDescriptionList__title eui-nd7d6t-euiDescriptionList__title-column-m-normal">Related Integrations</dt><dd class="euiDescriptionList__description eui-k4vc05-euiDescriptionList__description-column-normal-m"><p><a class="euiLink eui-zxmf4e-euiLink-primary" href="https://docs.elastic.co/en/integrations/aws" target="_blank" rel="noopener">aws<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" class="euiIcon eui-1ed6zfh-euiIcon-s-euiLink__externalIcon" role="img" aria-label="External link" aria-hidden="true"></svg><span class="eui-194jjcc-euiScreenReaderOnly-euiLink__screenReaderText">(opens in a new tab or window)</span></a></p></dd><dt class="euiDescriptionList__title eui-nd7d6t-euiDescriptionList__title-column-m-normal">Query</dt><dd class="euiDescriptionList__description eui-k4vc05-euiDescriptionList__description-column-normal-m"></dd></dl><div class="euiSpacer euiSpacer--m eui-jv9za2-euiSpacer-m"></div><div class="euiCodeBlock euiCodeBlock--fontSmall euiCodeBlock--paddingLarge"><pre class="euiCodeBlock__pre euiCodeBlock__pre--whiteSpacePreWrap" tabindex="-1"><code class="euiCodeBlock__code" data-code-language="text"><span class="euiCodeBlock__line">from logs-aws.cloudtrail-*
</span><span class="euiCodeBlock__line">
</span><span class="euiCodeBlock__line">// filter for DescribeInstances API calls
</span><span class="euiCodeBlock__line">| where event.dataset == &quot;aws.cloudtrail&quot; and event.provider == &quot;ec2.amazonaws.com&quot; and event.action == &quot;DescribeInstances&quot;
</span><span class="euiCodeBlock__line">
</span><span class="euiCodeBlock__line">// truncate the timestamp to a 30-second window
</span><span class="euiCodeBlock__line">| eval target_time_window = DATE_TRUNC(30 seconds, @timestamp)
</span><span class="euiCodeBlock__line">
</span><span class="euiCodeBlock__line">// keep only the relevant fields
</span><span class="euiCodeBlock__line">| keep target_time_window, aws.cloudtrail.user_identity.arn, cloud.region
</span><span class="euiCodeBlock__line">
</span><span class="euiCodeBlock__line">// count the number of unique regions and total API calls within the 30-second window
</span><span class="euiCodeBlock__line">| stats region_count = count_distinct(cloud.region), window_count = count(*) by target_time_window, aws.cloudtrail.user_identity.arn
</span><span class="euiCodeBlock__line">
</span><span class="euiCodeBlock__line">// filter for resources making DescribeInstances API calls in more than 10 regions within the 30-second window
</span><span class="euiCodeBlock__line">| where region_count &gt;= 10 and window_count &gt;= 10
</span><span class="euiCodeBlock__line">
</span><span class="euiCodeBlock__line">// sort the results by time windows in descending order
</span><span class="euiCodeBlock__line">| sort target_time_window desc
</span><span class="euiCodeBlock__line"></span></code></pre></div></div></div></div><div class="euiPanel euiPanel--primary euiPanel--paddingMedium euiCallOut euiCallOut--primary eui-1htmxq-euiPanel-none-m-primary-euiCallOut"><p class="euiTitle euiCallOutHeader__title eui-akxjbi-euiTitle-xs-euiCallOutHeader-primary"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" class="euiIcon eui-vlvl53-euiIcon-m-inherit-euiCallOut__icon" role="img" aria-hidden="true"></svg>Install detection rules in Elastic Security</p><div class="euiText eui-1hexw8x-euiText-s-euiTextColor-default-euiCallOut__description"><div class="euiSpacer euiSpacer--s eui-78drzl-euiSpacer-s"></div><p>Detect <!-- -->AWS EC2 Multi-Region DescribeInstances API Calls<!-- --> in the Elastic Security detection engine by installing this rule into your Elastic Stack.</p><p>To setup this rule, check out the installation guide for<!-- --> <a class="euiLink eui-zxmf4e-euiLink-primary" href="https://www.elastic.co/guide/en/security/current/prebuilt-rules-management.html" target="_blank" rel="noopener">Prebuilt Security Detection Rules<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" class="euiIcon eui-1ed6zfh-euiIcon-s-euiLink__externalIcon" role="img" aria-label="External link" aria-hidden="true"></svg><span class="eui-194jjcc-euiScreenReaderOnly-euiLink__screenReaderText">(opens in a new tab or window)</span></a>.</p></div></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"rule":{"metadata":{"creation_date":"2024/08/26","integration":["aws"],"maturity":"production","updated_date":"2024/11/07"},"rule":{"author":["Elastic"],"description":"Identifies when a single AWS resource is making `DescribeInstances` API calls in more than 10 regions within a 30-second\nwindow. This could indicate a potential threat actor attempting to discover the AWS infrastructure across multiple\nregions using compromised credentials or a compromised instance. Adversaries may use this information to identify\npotential targets for further exploitation or to gain a better understanding of the target's infrastructure.\n","false_positives":["    Legitimate use of the `DescribeInstances` API call by an AWS resource that requires information about instances in\n    multiple regions.\n    ","Scheduled tasks or scripts that require information about instances in multiple regions."],"from":"now-9m","language":"esql","license":"Elastic License v2","name":"AWS EC2 Multi-Region DescribeInstances API Calls","note":"## Triage and Analysis\n\n### Investigating AWS EC2 Multi-Region DescribeInstances API Calls\n\nThis rule detects instances where a single AWS resource makes `DescribeInstances` API calls in over 10 regions within a 30-second window. This could indicate an adversary using compromised credentials or an exploited resource to enumerate AWS infrastructure across multiple regions. Attackers often leverage multi-region enumeration to assess the overall cloud environment and find potential targets for further exploitation.\n\n#### Possible Investigation Steps\n\n- **Identify the Resource and Actor**:\n  - **Actor ARN**: Check `aws.cloudtrail.user_identity.arn` to determine the exact identity performing the enumeration. Validate if the user is expected to perform region-wide `DescribeInstances` actions across multiple regions or if it seems unusual.\n  - **Account and Role Details**: Examine `cloud.account.id` and `aws.cloudtrail.user_identity.session_context.session_issuer` for information about the AWS account and specific role associated with the action.\n\n- **Analyze API Call Patterns**:\n  - **Frequency and Scope**: Review `cloud.region` field and confirm if this specific resource commonly performs `DescribeInstances` calls across multiple regions.\n  - **Time Window Context**: Compare the timing of the API calls within the `target_time_window` to determine if this burst pattern aligns with expected system usage or is potentially malicious.\n\n- **Check User Agent and Tooling**:\n  - **Source and User Agent**: Verify `user_agent.original` to determine if the request was made through expected tooling (e.g., AWS CLI or SDK) or a third-party tool that might indicate non-standard access.\n  - **Source IP Address**: Look into `source.address` to identify the origin of the calls. Unusual IP addresses, especially those outside expected ranges, may indicate compromised access.\n\n- **Evaluate for Potential Reconnaissance Behavior**:\n  - **Account and Region Enumeration**: Adversaries may use region-wide `DescribeInstances` requests to discover resources within an account across different regions. Confirm if this access aligns with operational practices or represents excessive access.\n  - **Permissions and Roles**: Investigate the permissions associated with the user role. Excessive permissions on a compromised role may allow broader enumeration, which should be restricted.\n\n- **Review Related CloudTrail Events**:\n  - **Additional Describe or List Actions**: Identify any associated `Describe` or `List` API calls that may indicate further enumeration of other AWS services within the same timeframe.\n  - **Potential Preceding Events**: Look for preceding login or access events from the same actor, as these may indicate potential credential compromise or unauthorized escalation of privileges.\n\n### False Positive Analysis\n\n- **Expected Enumeration**: Certain administrative or automation scripts may conduct broad `DescribeInstances` API calls for inventory purposes. Review usage patterns or consult relevant teams to validate the purpose.\n- **Automated Cloud Management**: Some automated services may perform regional checks for compliance or backup operations. If this rule is triggered repeatedly by a known service, consider whitelisting or tuning accordingly.\n\n### Response and Remediation\n\n- **Review IAM Policies and Role Permissions**: Limit the permissions of roles associated with this resource, restricting unnecessary multi-region enumeration access.\n- **Enforce Least Privilege Access**: Ensure that permissions for DescribeInstances are tightly controlled and restricted to specific roles or accounts that require multi-region access.\n- **Increase Monitoring and Alerts**: Set up additional monitoring on this role or account for further signs of unauthorized activity or lateral movement attempts.\n- **Access Review**: Conduct a review of users and entities with `DescribeInstances` permissions, especially for multi-region capabilities, and ensure these permissions are necessary for their functions.\n\n### Additional Information\n\nFor further information on AWS `DescribeInstances` permissions and best practices, refer to the [AWS DescribeInstances API documentation](https://docs.aws.amazon.com/AWSEC2/latest/APIReference/API_DescribeInstances.html).\n","references":["https://www.sentinelone.com/labs/exploring-fbot-python-based-malware-targeting-cloud-and-payment-services/","https://docs.aws.amazon.com/AWSEC2/latest/APIReference/API_DescribeInstances.html"],"risk_score":21,"rule_id":"393ef120-63d1-11ef-8e38-f661ea17fbce","severity":"low","tags":["Domain: Cloud","Data Source: AWS","Data Source: AWS EC2","Resources: Investigation Guide","Use Case: Threat Detection","Tactic: Discovery"],"timestamp_override":"event.ingested","type":"esql","query":"from logs-aws.cloudtrail-*\n\n// filter for DescribeInstances API calls\n| where event.dataset == \"aws.cloudtrail\" and event.provider == \"ec2.amazonaws.com\" and event.action == \"DescribeInstances\"\n\n// truncate the timestamp to a 30-second window\n| eval target_time_window = DATE_TRUNC(30 seconds, @timestamp)\n\n// keep only the relevant fields\n| keep target_time_window, aws.cloudtrail.user_identity.arn, cloud.region\n\n// count the number of unique regions and total API calls within the 30-second window\n| stats region_count = count_distinct(cloud.region), window_count = count(*) by target_time_window, aws.cloudtrail.user_identity.arn\n\n// filter for resources making DescribeInstances API calls in more than 10 regions within the 30-second window\n| where region_count \u003e= 10 and window_count \u003e= 10\n\n// sort the results by time windows in descending order\n| sort target_time_window desc\n","investigation_fields":{"field_names":["aws.cloudtrail.user_identity.arn","target_time_window","region_count","window_count"]},"threat":[{"framework":"MITRE ATT\u0026CK","technique":[{"id":"T1580","name":"Cloud Infrastructure Discovery","reference":"https://attack.mitre.org/techniques/T1580/"}],"tactic":{"id":"TA0007","name":"Discovery","reference":"https://attack.mitre.org/tactics/TA0007/"}}]}}},"__N_SSG":true},"page":"/rules/[id]","query":{"id":"393ef120-63d1-11ef-8e38-f661ea17fbce"},"buildId":"s1hqWXw4jXJXWFVds7Yqk","assetPrefix":"/detection-rules-explorer","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>