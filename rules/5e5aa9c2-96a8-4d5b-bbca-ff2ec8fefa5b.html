<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><title>Home</title><meta name="next-head-count" content="3"/><meta name="description" content="Detection Rules is the home for rules used by Elastic Security."/><meta property="og:title" content="Elastic Detection Rules"/><meta property="og:description" content="Detection Rules is the home for rules used by Elastic Security."/><meta property="og:url" content="https://github.com/elastic/detection-rules"/><link rel="stylesheet" href="/detection-rules-explorer/themes/eui_theme_dark.45c087c0a7ccec8a2229.min.css" data-name="eui-theme" data-theme-name="Dark" data-theme="dark" disabled="" aria-disabled="true"/><link rel="stylesheet" href="/detection-rules-explorer/themes/eui_theme_light.3de9904404a3ccaf0ed2.min.css" data-name="eui-theme" data-theme-name="Light" data-theme="light"/><link rel="icon" type="image/png" href="/detection-rules-explorer/images/favicon/prod/favicon-16x16.png" sizes="16x16"/><link rel="icon" type="image/png" href="/detection-rules-explorer/images/favicon/prod/favicon-32x32.png" sizes="32x32"/><link rel="icon" type="image/png" href="/detection-rules-explorer/images/favicon/prod/favicon-96x96.png" sizes="96x96"/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/detection-rules-explorer/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/detection-rules-explorer/_next/static/chunks/webpack-d444f824b18ba952.js" defer=""></script><script src="/detection-rules-explorer/_next/static/chunks/framework-79bce4a3a540b080.js" defer=""></script><script src="/detection-rules-explorer/_next/static/chunks/main-4be6f7e434f4c65e.js" defer=""></script><script src="/detection-rules-explorer/_next/static/chunks/pages/_app-f608ed562a5d9c84.js" defer=""></script><script src="/detection-rules-explorer/_next/static/chunks/4218-ffcd6b15488cdf6f.js" defer=""></script><script src="/detection-rules-explorer/_next/static/chunks/8738-e43f3c136aaac828.js" defer=""></script><script src="/detection-rules-explorer/_next/static/chunks/1304-34d1d6ab0f19548d.js" defer=""></script><script src="/detection-rules-explorer/_next/static/chunks/pages/rules/%5Bid%5D-4ed28d85cbc13b0b.js" defer=""></script><script src="/detection-rules-explorer/_next/static/DWQS6pm9RJ7Fjm_-WIo5n/_buildManifest.js" defer=""></script><script src="/detection-rules-explorer/_next/static/DWQS6pm9RJ7Fjm_-WIo5n/_ssgManifest.js" defer=""></script></head><body class="guideBody"><div id="__next" data-reactroot=""><style data-emotion="css-global 2hgghz">#__next,.guideBody{min-height:100%;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;}</style><div class="euiHeader euiHeader--default euiHeader--fixed"><div class="euiHeaderSection euiHeaderSection--dontGrow euiHeaderSection--left"><div class="euiHeaderSectionItem"><a href="/detection-rules-explorer" class="eui-jxpcya"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" class="euiIcon eui-7yvbl4-euiIcon-l" role="img" aria-hidden="true"></svg><span class="euiTitle eui-z21xof-euiTitle-xxs">Elastic Security Detection Rules</span></a></div></div><div class="euiHeaderSection euiHeaderSection--dontGrow euiHeaderSection--left"><div class="euiHeaderSectionItem"><span class="euiToolTipAnchor eui-jcaat8-euiToolTipAnchor-inlineBlock"><button class="euiButtonEmpty euiHeaderSectionItemButton eui-wvaqcf-empty-text" type="button" aria-label="Change theme"><span class="euiButtonContent euiButtonEmpty__content"><span class="euiButtonEmpty__text"><span class="euiHeaderSectionItemButton__content"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" class="euiIcon eui-4394ro-euiIcon-m" role="img" aria-hidden="true"></svg></span></span></span></button></span></div><div class="euiHeaderSectionItem"><span class="euiToolTipAnchor eui-jcaat8-euiToolTipAnchor-inlineBlock"><a class="euiButtonEmpty euiHeaderSectionItemButton eui-wvaqcf-empty-text" href="https://github.com/elastic/detection-rules" rel="noreferrer" aria-label="EUI GitHub repo"><span class="euiButtonContent euiButtonEmpty__content"><span class="euiButtonEmpty__text"><span class="euiHeaderSectionItemButton__content"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" class="euiIcon eui-2txxin-euiIcon-m" role="img" aria-hidden="true"></svg></span></span></span></a></span></div></div></div><div class="eui-gok634"><div class="eui-1kqz3nm"><div class="euiFlexGroup euiFlexGroup--gutterLarge euiFlexGroup--directionRow euiFlexGroup--responsive eui-lw6o6k"><div class="euiFlexItem"><div class="euiPanel euiPanel--plain euiPanel--paddingMedium eui-1yzwxdg-euiPanel-grow-m-m-plain-hasShadow"><h1 class="euiTitle eui-smz32e-euiTitle-m"></h1><div class="euiSpacer euiSpacer--s eui-78drzl-euiSpacer-s"></div><div class="euiText eui-x1zygz-euiText-s-euiTextColor-subdued">Last updated <!-- -->55 years ago<!-- --> on<!-- --> <!-- -->1970-01-01</div><div class="euiText eui-x1zygz-euiText-s-euiTextColor-subdued">Created <!-- -->55 years ago<!-- --> on<!-- --> <!-- -->1970-01-01</div></div></div></div><div class="euiFlexGroup euiFlexGroup--gutterLarge euiFlexGroup--directionRow euiFlexGroup--responsive eui-lw6o6k"><div class="euiFlexItem"><div class="euiPanel euiPanel--plain euiPanel--paddingMedium eui-1yzwxdg-euiPanel-grow-m-m-plain-hasShadow"><h1 class="euiTitle eui-smz32e-euiTitle-m">About</h1><div class="euiSpacer euiSpacer--l eui-p2o3x6-euiSpacer-l"></div><div class="euiText eui-1yivsv3-euiText-m">This hunt identifies browser or svchost instances performing a considerable number of connections per hour over an extended period of hours to a specific destination address, limited to a unique host of the monitored agents. Browsers and svchost are both good targets for masquerading network traffic on the endpoint.
</div><div class="euiSpacer euiSpacer--l eui-p2o3x6-euiSpacer-l"></div><dl class="euiDescriptionList eui-12pc6e7-euiDescriptionList-column-left" data-type="column"><dt class="euiDescriptionList__title eui-nd7d6t-euiDescriptionList__title-column-m-normal">Tags</dt><dd class="euiDescriptionList__description eui-k4vc05-euiDescriptionList__description-column-normal-m"><span class="euiBadge eui-n49zn7-euiBadge" style="background-color:#D3DAE6;color:#000"><span class="euiBadge__content eui-1yj2yi7-euiBadge__content"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" class="euiIcon euiBadge__icon eui-1uiqggp-euiIcon-s-inherit-euiBadge__icon-left" role="img" aria-hidden="true"></svg><span class="euiBadge__text eui-1vg55k4-euiBadge__text">Hunt Type: Hunt</span></span></span></dd><dt class="euiDescriptionList__title eui-nd7d6t-euiDescriptionList__title-column-m-normal">Severity</dt><dd class="euiDescriptionList__description eui-k4vc05-euiDescriptionList__description-column-normal-m"><div class="euiHealth eui-qn8ayk-euiHealth-s"><div class="euiFlexGroup euiFlexGroup--gutterExtraSmall euiFlexGroup--alignItemsCenter euiFlexGroup--directionRow"><div class="euiFlexItem euiFlexItem--flexGrowZero"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" class="euiIcon eui-1b2fr2v-euiIcon-m-subdued" role="img" aria-hidden="true"></svg></div><div class="euiFlexItem euiFlexItem--flexGrowZero"></div></div></div></dd><dt class="euiDescriptionList__title eui-nd7d6t-euiDescriptionList__title-column-m-normal">MITRE ATT&amp;CK™</dt><dd class="euiDescriptionList__description eui-k4vc05-euiDescriptionList__description-column-normal-m"><p><a class="euiLink eui-zxmf4e-euiLink-primary" href="" target="_blank" rel="noopener noreferrer"> (<!-- -->)<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" class="euiIcon eui-1ed6zfh-euiIcon-s-euiLink__externalIcon" role="img" aria-label="External link" aria-hidden="true"></svg><span class="eui-194jjcc-euiScreenReaderOnly-euiLink__screenReaderText">(opens in a new tab or window)</span></a><div class="euiText eui-14lwe4a-euiText-xs"><p><a class="euiLink eui-zxmf4e-euiLink-primary" href="https://attack.mitre.org/techniques/T1071/" target="_blank" rel="noopener noreferrer">↳ <!-- --> (<!-- -->T1071<!-- -->)<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" class="euiIcon eui-1ed6zfh-euiIcon-s-euiLink__externalIcon" role="img" aria-label="External link" aria-hidden="true"></svg><span class="eui-194jjcc-euiScreenReaderOnly-euiLink__screenReaderText">(opens in a new tab or window)</span></a></p></div><div class="euiSpacer euiSpacer--xs eui-1wffcmx-euiSpacer-xs"></div></p></dd><dt class="euiDescriptionList__title eui-nd7d6t-euiDescriptionList__title-column-m-normal">License</dt><dd class="euiDescriptionList__description eui-k4vc05-euiDescriptionList__description-column-normal-m"><a class="euiLink eui-zxmf4e-euiLink-primary" href="https://www.elastic.co/licensing/elastic-license" target="_blank" rel="noopener">Elastic License v2<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" class="euiIcon eui-1ed6zfh-euiIcon-s-euiLink__externalIcon" role="img" aria-label="External link" aria-hidden="true"></svg><span class="eui-194jjcc-euiScreenReaderOnly-euiLink__screenReaderText">(opens in a new tab or window)</span></a></dd></dl></div></div><div class="euiFlexItem"><div class="euiPanel euiPanel--plain euiPanel--paddingMedium eui-1yzwxdg-euiPanel-grow-m-m-plain-hasShadow"><h1 class="euiTitle eui-smz32e-euiTitle-m">Definition</h1><div class="euiSpacer euiSpacer--l eui-p2o3x6-euiSpacer-l"></div><dl class="euiDescriptionList eui-12pc6e7-euiDescriptionList-column-left" data-type="column"><dt class="euiDescriptionList__title eui-nd7d6t-euiDescriptionList__title-column-m-normal">Integration Pack</dt><dd class="euiDescriptionList__description eui-k4vc05-euiDescriptionList__description-column-normal-m">Prebuilt Security Detection Rules</dd><dt class="euiDescriptionList__title eui-nd7d6t-euiDescriptionList__title-column-m-normal">Related Integrations</dt><dd class="euiDescriptionList__description eui-k4vc05-euiDescriptionList__description-column-normal-m"><p><a class="euiLink eui-zxmf4e-euiLink-primary" href="https://docs.elastic.co/en/integrations/endpoint" target="_blank" rel="noopener">endpoint<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" class="euiIcon eui-1ed6zfh-euiIcon-s-euiLink__externalIcon" role="img" aria-label="External link" aria-hidden="true"></svg><span class="eui-194jjcc-euiScreenReaderOnly-euiLink__screenReaderText">(opens in a new tab or window)</span></a></p><p><a class="euiLink eui-zxmf4e-euiLink-primary" href="https://docs.elastic.co/en/integrations/windows" target="_blank" rel="noopener">windows<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" class="euiIcon eui-1ed6zfh-euiIcon-s-euiLink__externalIcon" role="img" aria-label="External link" aria-hidden="true"></svg><span class="eui-194jjcc-euiScreenReaderOnly-euiLink__screenReaderText">(opens in a new tab or window)</span></a></p></dd><dt class="euiDescriptionList__title eui-nd7d6t-euiDescriptionList__title-column-m-normal">Query</dt><dd class="euiDescriptionList__description eui-k4vc05-euiDescriptionList__description-column-normal-m"></dd></dl><div class="euiSpacer euiSpacer--m eui-jv9za2-euiSpacer-m"></div><div class="euiCodeBlock euiCodeBlock--fontSmall euiCodeBlock--paddingLarge"><pre class="euiCodeBlock__pre euiCodeBlock__pre--whiteSpacePreWrap" tabindex="-1"><code class="euiCodeBlock__code" data-code-language="text">from logs-endpoint.events.network-*, logs-windows.sysmon_operational-*
| where host.os.family == &quot;windows&quot; and event.category == &quot;network&quot; and
  network.direction == &quot;egress&quot; and process.name in (&quot;chrome.exe&quot;, &quot;msedge.exe&quot;, &quot;iexplore.exe&quot;, &quot;firefox.exe&quot;, &quot;svchost.exe&quot;) and
 /* excluding DNS */
 destination.port != 53 and
 /* excluding private IP ranges */
  not CIDR_MATCH(destination.ip, &quot;10.0.0.0/8&quot;, &quot;127.0.0.0/8&quot;, &quot;169.254.0.0/16&quot;, &quot;172.16.0.0/12&quot;, &quot;192.0.0.0/24&quot;, &quot;192.0.0.0/29&quot;, &quot;192.0.0.8/32&quot;, &quot;192.0.0.9/32&quot;, &quot;192.0.0.10/32&quot;, &quot;192.0.0.170/32&quot;, &quot;192.0.0.171/32&quot;, &quot;192.0.2.0/24&quot;, &quot;192.31.196.0/24&quot;, &quot;192.52.193.0/24&quot;, &quot;192.168.0.0/16&quot;, &quot;192.88.99.0/24&quot;, &quot;224.0.0.0/4&quot;, &quot;100.64.0.0/10&quot;, &quot;192.175.48.0/24&quot;,&quot;198.18.0.0/15&quot;, &quot;198.51.100.0/24&quot;, &quot;203.0.113.0/24&quot;, &quot;240.0.0.0/4&quot;, &quot;::1&quot;,&quot;FE80::/10&quot;, &quot;FF00::/8&quot;)
| keep source.bytes, destination.address, process.name, process.entity_id, @timestamp, host.id
 /* calc total duration and the number of connections per hour */
| stats count_connections = count(*), start_time = min(@timestamp), end_time = max(@timestamp), hosts= count_distinct(host.id), count_unique_pids = count_distinct(process.entity_id) by  destination.address, process.name
| eval dur = TO_DOUBLE(end_time)-TO_DOUBLE(start_time), duration_hours=TO_INT(dur/3600000), number_of_con_per_hour = (count_connections / duration_hours)
| keep process.name, duration_hours, destination.address, hosts, count_unique_pids, count_connections, number_of_con_per_hour
 /* threshold is set to 120 connections per minute during 4 hours and limited to 1 agent and 1 pid, you can adjust this values to your hunting needs */
| where number_of_con_per_hour &gt;= 120 and duration_hours &gt;= 4 and hosts == 1 and count_unique_pids == 1
<!-- -->from logs-endpoint.events.network-*
| where @timestamp &gt; now() - 7 day
| where host.os.family == &quot;windows&quot; and event.category == &quot;network&quot; and
  network.direction == &quot;egress&quot; and
(process.code_signature.exists == false or process.code_signature.trusted != true or starts_with(process.executable, &quot;C:\\Users\\Public\\&quot;))  and
 /* excluding private IP ranges */
  not CIDR_MATCH(destination.ip, &quot;10.0.0.0/8&quot;, &quot;127.0.0.0/8&quot;, &quot;169.254.0.0/16&quot;, &quot;172.16.0.0/12&quot;, &quot;192.0.0.0/24&quot;, &quot;192.0.0.0/29&quot;, &quot;192.0.0.8/32&quot;, &quot;192.0.0.9/32&quot;, &quot;192.0.0.10/32&quot;, &quot;192.0.0.170/32&quot;, &quot;192.0.0.171/32&quot;, &quot;192.0.2.0/24&quot;, &quot;192.31.196.0/24&quot;, &quot;192.52.193.0/24&quot;, &quot;192.168.0.0/16&quot;, &quot;192.88.99.0/24&quot;, &quot;224.0.0.0/4&quot;, &quot;100.64.0.0/10&quot;, &quot;192.175.48.0/24&quot;,&quot;198.18.0.0/15&quot;, &quot;198.51.100.0/24&quot;, &quot;203.0.113.0/24&quot;, &quot;240.0.0.0/4&quot;, &quot;::1&quot;,&quot;FE80::/10&quot;, &quot;FF00::/8&quot;)
| keep source.bytes, destination.address, process.name, process.entity_id, @timestamp
 /* calc total duration , total MB out and the number of connections per hour */
| stats total_bytes_out = sum(source.bytes), count_connections = count(*), start_time = min(@timestamp), end_time = max(@timestamp) by process.entity_id, destination.address, process.name
| eval dur = TO_DOUBLE(end_time)-TO_DOUBLE(start_time), duration_hours=TO_INT(dur/3600000), MB_out=TO_DOUBLE(total_bytes_out) / (1024*1024), number_of_con_per_hour = (count_connections / duration_hours)
| keep process.entity_id, process.name, duration_hours, destination.address, MB_out, count_connections, number_of_con_per_hour
 /* threshold is set to 120 connections per minute , you can adjust it to your env/FP rate */
| where duration_hours &gt;= 1 and number_of_con_per_hour &gt;= 120
<!-- -->from logs-endpoint.events.network-*, logs-windows.sysmon_operational-*
| where @timestamp &gt; now() - 7 day
| where host.os.family == &quot;windows&quot; and event.category == &quot;network&quot; and
  network.direction == &quot;egress&quot; and (process.executable like &quot;C:\\\\Windows\\\\System32*&quot; or process.executable like &quot;C:\\\\Windows\\\\SysWOW64\\\\*&quot;)  and not user.id in (&quot;S-1-5-19&quot;, &quot;S-1-5-20&quot;) and
/* multiple Windows svchost services perform long term connection to MS ASN, can be covered in a dedicated hunt */
not (process.name == &quot;svchost.exe&quot; and user.id == &quot;S-1-5-18&quot;) and
/* excluding private IP ranges */
  not CIDR_MATCH(destination.ip, &quot;10.0.0.0/8&quot;, &quot;127.0.0.0/8&quot;, &quot;169.254.0.0/16&quot;, &quot;172.16.0.0/12&quot;, &quot;192.0.0.0/24&quot;, &quot;192.0.0.0/29&quot;, &quot;192.0.0.8/32&quot;, &quot;192.0.0.9/32&quot;, &quot;192.0.0.10/32&quot;, &quot;192.0.0.170/32&quot;, &quot;192.0.0.171/32&quot;, &quot;192.0.2.0/24&quot;, &quot;192.31.196.0/24&quot;, &quot;192.52.193.0/24&quot;, &quot;192.168.0.0/16&quot;, &quot;192.88.99.0/24&quot;, &quot;224.0.0.0/4&quot;, &quot;100.64.0.0/10&quot;, &quot;192.175.48.0/24&quot;,&quot;198.18.0.0/15&quot;, &quot;198.51.100.0/24&quot;, &quot;203.0.113.0/24&quot;, &quot;240.0.0.0/4&quot;, &quot;::1&quot;,&quot;FE80::/10&quot;, &quot;FF00::/8&quot;)
| keep source.bytes, destination.address, process.name, process.entity_id, @timestamp
 /* calc total duration , total MB out and the number of connections per hour */
| stats total_bytes_out = sum(source.bytes), count_connections = count(*), start_time = min(@timestamp), end_time = max(@timestamp) by process.entity_id, destination.address, process.name
| eval dur = TO_DOUBLE(end_time)-TO_DOUBLE(start_time), duration_hours=TO_INT(dur/3600000), MB_out=TO_DOUBLE(total_bytes_out) / (1024*1024), number_of_con_per_hour = (count_connections / duration_hours)
| keep process.entity_id, process.name, duration_hours, destination.address, MB_out, count_connections, number_of_con_per_hour
/* threshold is set to 120 connections per minute , you can adjust it to your env/FP rate */
| where duration_hours &gt;= 1 and number_of_con_per_hour &gt;= 120
</code></pre></div></div></div></div><div class="euiPanel euiPanel--primary euiPanel--paddingMedium euiCallOut euiCallOut--primary eui-1htmxq-euiPanel-none-m-primary-euiCallOut"><p class="euiTitle euiCallOutHeader__title eui-akxjbi-euiTitle-xs-euiCallOutHeader-primary"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" class="euiIcon eui-vlvl53-euiIcon-m-inherit-euiCallOut__icon" role="img" aria-hidden="true"></svg>Install detection rules in Elastic Security</p><div class="euiText eui-1hexw8x-euiText-s-euiTextColor-default-euiCallOut__description"><div class="euiSpacer euiSpacer--s eui-78drzl-euiSpacer-s"></div><p>Detect <!-- --> in the Elastic Security detection engine by installing this rule into your Elastic Stack.</p><p>To setup this rule, check out the installation guide for<!-- --> <a class="euiLink eui-zxmf4e-euiLink-primary" href="https://www.elastic.co/guide/en/security/current/prebuilt-rules-management.html" target="_blank" rel="noopener">Prebuilt Security Detection Rules<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" class="euiIcon eui-1ed6zfh-euiIcon-s-euiLink__externalIcon" role="img" aria-label="External link" aria-hidden="true"></svg><span class="eui-194jjcc-euiScreenReaderOnly-euiLink__screenReaderText">(opens in a new tab or window)</span></a>.</p></div></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"rule":{"hunt":{"author":"Elastic","description":"This hunt identifies browser or svchost instances performing a considerable number of connections per hour over an extended period of hours to a specific destination address, limited to a unique host of the monitored agents. Browsers and svchost are both good targets for masquerading network traffic on the endpoint.\n","integration":["endpoint","windows"],"uuid":"5e5aa9c2-96a8-4d5b-bbca-ff2ec8fefa5b","name":"High Count of Network Connection Over Extended Period by Process","language":["ES|QL"],"license":"Elastic License v2","notes":["This hunt includes three queries for Elastic Defend and Sysmon data sources."],"mitre":["T1071"],"query":["from logs-endpoint.events.network-*, logs-windows.sysmon_operational-*\n| where host.os.family == \"windows\" and event.category == \"network\" and\n  network.direction == \"egress\" and process.name in (\"chrome.exe\", \"msedge.exe\", \"iexplore.exe\", \"firefox.exe\", \"svchost.exe\") and\n /* excluding DNS */\n destination.port != 53 and\n /* excluding private IP ranges */\n  not CIDR_MATCH(destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\", \"192.0.0.0/29\", \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\", \"192.0.2.0/24\", \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\", \"100.64.0.0/10\", \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\",\"FE80::/10\", \"FF00::/8\")\n| keep source.bytes, destination.address, process.name, process.entity_id, @timestamp, host.id\n /* calc total duration and the number of connections per hour */\n| stats count_connections = count(*), start_time = min(@timestamp), end_time = max(@timestamp), hosts= count_distinct(host.id), count_unique_pids = count_distinct(process.entity_id) by  destination.address, process.name\n| eval dur = TO_DOUBLE(end_time)-TO_DOUBLE(start_time), duration_hours=TO_INT(dur/3600000), number_of_con_per_hour = (count_connections / duration_hours)\n| keep process.name, duration_hours, destination.address, hosts, count_unique_pids, count_connections, number_of_con_per_hour\n /* threshold is set to 120 connections per minute during 4 hours and limited to 1 agent and 1 pid, you can adjust this values to your hunting needs */\n| where number_of_con_per_hour \u003e= 120 and duration_hours \u003e= 4 and hosts == 1 and count_unique_pids == 1\n","from logs-endpoint.events.network-*\n| where @timestamp \u003e now() - 7 day\n| where host.os.family == \"windows\" and event.category == \"network\" and\n  network.direction == \"egress\" and\n(process.code_signature.exists == false or process.code_signature.trusted != true or starts_with(process.executable, \"C:\\\\Users\\\\Public\\\\\"))  and\n /* excluding private IP ranges */\n  not CIDR_MATCH(destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\", \"192.0.0.0/29\", \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\", \"192.0.2.0/24\", \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\", \"100.64.0.0/10\", \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\",\"FE80::/10\", \"FF00::/8\")\n| keep source.bytes, destination.address, process.name, process.entity_id, @timestamp\n /* calc total duration , total MB out and the number of connections per hour */\n| stats total_bytes_out = sum(source.bytes), count_connections = count(*), start_time = min(@timestamp), end_time = max(@timestamp) by process.entity_id, destination.address, process.name\n| eval dur = TO_DOUBLE(end_time)-TO_DOUBLE(start_time), duration_hours=TO_INT(dur/3600000), MB_out=TO_DOUBLE(total_bytes_out) / (1024*1024), number_of_con_per_hour = (count_connections / duration_hours)\n| keep process.entity_id, process.name, duration_hours, destination.address, MB_out, count_connections, number_of_con_per_hour\n /* threshold is set to 120 connections per minute , you can adjust it to your env/FP rate */\n| where duration_hours \u003e= 1 and number_of_con_per_hour \u003e= 120\n","from logs-endpoint.events.network-*, logs-windows.sysmon_operational-*\n| where @timestamp \u003e now() - 7 day\n| where host.os.family == \"windows\" and event.category == \"network\" and\n  network.direction == \"egress\" and (process.executable like \"C:\\\\\\\\Windows\\\\\\\\System32*\" or process.executable like \"C:\\\\\\\\Windows\\\\\\\\SysWOW64\\\\\\\\*\")  and not user.id in (\"S-1-5-19\", \"S-1-5-20\") and\n/* multiple Windows svchost services perform long term connection to MS ASN, can be covered in a dedicated hunt */\nnot (process.name == \"svchost.exe\" and user.id == \"S-1-5-18\") and\n/* excluding private IP ranges */\n  not CIDR_MATCH(destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\", \"192.0.0.0/29\", \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\", \"192.0.2.0/24\", \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\", \"100.64.0.0/10\", \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\",\"FE80::/10\", \"FF00::/8\")\n| keep source.bytes, destination.address, process.name, process.entity_id, @timestamp\n /* calc total duration , total MB out and the number of connections per hour */\n| stats total_bytes_out = sum(source.bytes), count_connections = count(*), start_time = min(@timestamp), end_time = max(@timestamp) by process.entity_id, destination.address, process.name\n| eval dur = TO_DOUBLE(end_time)-TO_DOUBLE(start_time), duration_hours=TO_INT(dur/3600000), MB_out=TO_DOUBLE(total_bytes_out) / (1024*1024), number_of_con_per_hour = (count_connections / duration_hours)\n| keep process.entity_id, process.name, duration_hours, destination.address, MB_out, count_connections, number_of_con_per_hour\n/* threshold is set to 120 connections per minute , you can adjust it to your env/FP rate */\n| where duration_hours \u003e= 1 and number_of_con_per_hour \u003e= 120\n"]},"rule":{"tags":["Hunt Type: Hunt"],"query":["from logs-endpoint.events.network-*, logs-windows.sysmon_operational-*\n| where host.os.family == \"windows\" and event.category == \"network\" and\n  network.direction == \"egress\" and process.name in (\"chrome.exe\", \"msedge.exe\", \"iexplore.exe\", \"firefox.exe\", \"svchost.exe\") and\n /* excluding DNS */\n destination.port != 53 and\n /* excluding private IP ranges */\n  not CIDR_MATCH(destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\", \"192.0.0.0/29\", \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\", \"192.0.2.0/24\", \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\", \"100.64.0.0/10\", \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\",\"FE80::/10\", \"FF00::/8\")\n| keep source.bytes, destination.address, process.name, process.entity_id, @timestamp, host.id\n /* calc total duration and the number of connections per hour */\n| stats count_connections = count(*), start_time = min(@timestamp), end_time = max(@timestamp), hosts= count_distinct(host.id), count_unique_pids = count_distinct(process.entity_id) by  destination.address, process.name\n| eval dur = TO_DOUBLE(end_time)-TO_DOUBLE(start_time), duration_hours=TO_INT(dur/3600000), number_of_con_per_hour = (count_connections / duration_hours)\n| keep process.name, duration_hours, destination.address, hosts, count_unique_pids, count_connections, number_of_con_per_hour\n /* threshold is set to 120 connections per minute during 4 hours and limited to 1 agent and 1 pid, you can adjust this values to your hunting needs */\n| where number_of_con_per_hour \u003e= 120 and duration_hours \u003e= 4 and hosts == 1 and count_unique_pids == 1\n","from logs-endpoint.events.network-*\n| where @timestamp \u003e now() - 7 day\n| where host.os.family == \"windows\" and event.category == \"network\" and\n  network.direction == \"egress\" and\n(process.code_signature.exists == false or process.code_signature.trusted != true or starts_with(process.executable, \"C:\\\\Users\\\\Public\\\\\"))  and\n /* excluding private IP ranges */\n  not CIDR_MATCH(destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\", \"192.0.0.0/29\", \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\", \"192.0.2.0/24\", \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\", \"100.64.0.0/10\", \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\",\"FE80::/10\", \"FF00::/8\")\n| keep source.bytes, destination.address, process.name, process.entity_id, @timestamp\n /* calc total duration , total MB out and the number of connections per hour */\n| stats total_bytes_out = sum(source.bytes), count_connections = count(*), start_time = min(@timestamp), end_time = max(@timestamp) by process.entity_id, destination.address, process.name\n| eval dur = TO_DOUBLE(end_time)-TO_DOUBLE(start_time), duration_hours=TO_INT(dur/3600000), MB_out=TO_DOUBLE(total_bytes_out) / (1024*1024), number_of_con_per_hour = (count_connections / duration_hours)\n| keep process.entity_id, process.name, duration_hours, destination.address, MB_out, count_connections, number_of_con_per_hour\n /* threshold is set to 120 connections per minute , you can adjust it to your env/FP rate */\n| where duration_hours \u003e= 1 and number_of_con_per_hour \u003e= 120\n","from logs-endpoint.events.network-*, logs-windows.sysmon_operational-*\n| where @timestamp \u003e now() - 7 day\n| where host.os.family == \"windows\" and event.category == \"network\" and\n  network.direction == \"egress\" and (process.executable like \"C:\\\\\\\\Windows\\\\\\\\System32*\" or process.executable like \"C:\\\\\\\\Windows\\\\\\\\SysWOW64\\\\\\\\*\")  and not user.id in (\"S-1-5-19\", \"S-1-5-20\") and\n/* multiple Windows svchost services perform long term connection to MS ASN, can be covered in a dedicated hunt */\nnot (process.name == \"svchost.exe\" and user.id == \"S-1-5-18\") and\n/* excluding private IP ranges */\n  not CIDR_MATCH(destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\", \"192.0.0.0/29\", \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\", \"192.0.2.0/24\", \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\", \"100.64.0.0/10\", \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\",\"FE80::/10\", \"FF00::/8\")\n| keep source.bytes, destination.address, process.name, process.entity_id, @timestamp\n /* calc total duration , total MB out and the number of connections per hour */\n| stats total_bytes_out = sum(source.bytes), count_connections = count(*), start_time = min(@timestamp), end_time = max(@timestamp) by process.entity_id, destination.address, process.name\n| eval dur = TO_DOUBLE(end_time)-TO_DOUBLE(start_time), duration_hours=TO_INT(dur/3600000), MB_out=TO_DOUBLE(total_bytes_out) / (1024*1024), number_of_con_per_hour = (count_connections / duration_hours)\n| keep process.entity_id, process.name, duration_hours, destination.address, MB_out, count_connections, number_of_con_per_hour\n/* threshold is set to 120 connections per minute , you can adjust it to your env/FP rate */\n| where duration_hours \u003e= 1 and number_of_con_per_hour \u003e= 120\n"],"license":"Elastic License v2","description":"This hunt identifies browser or svchost instances performing a considerable number of connections per hour over an extended period of hours to a specific destination address, limited to a unique host of the monitored agents. Browsers and svchost are both good targets for masquerading network traffic on the endpoint.\n","threat":[{"framework":"MITRE ATT\u0026CK","tactic":{"id":"","name":"","reference":""},"technique":[{"id":"T1071","name":"","reference":"https://attack.mitre.org/techniques/T1071/"}]}]},"metadata":{"creation_date":"1970-01-01T00:00:00.000Z","updated_date":"1970-01-01T00:00:00.000Z","integration":["endpoint","windows"]}}},"__N_SSG":true},"page":"/rules/[id]","query":{"id":"5e5aa9c2-96a8-4d5b-bbca-ff2ec8fefa5b"},"buildId":"DWQS6pm9RJ7Fjm_-WIo5n","assetPrefix":"/detection-rules-explorer","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>